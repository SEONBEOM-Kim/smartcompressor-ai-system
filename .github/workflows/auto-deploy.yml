name: Auto Deploy to Signalcraft EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        script: |
          # 1. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/smartcompressor
          
          # 2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ Git Pull: ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          git pull origin main
          
          # 3. Node.js ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ NPM Install: Node.js íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
          npm install --production # --production í”Œë˜ê·¸ëŠ” ê°œë°œìš© íŒ¨í‚¤ì§€ë¥¼ ì œì™¸í•˜ì—¬ ë” ê°€ë³ê²Œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
          
          # 4. PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ (ë¬´ì¤‘ë‹¨)
          # ecosystem.config.js íŒŒì¼ì´ ìˆë‹¤ë©´ reload, ì—†ë‹¤ë©´ restartë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          echo "ğŸš€ PM2 Reload: ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
          pm2 reload ecosystem.config.js --env production || pm2 restart all
          
          # 5. Nginx ì›¹ì„œë²„ ì¬ì‹œì‘ (í•„ìš”ì‹œ)
          # Nginx ì„¤ì • ë³€ê²½ì´ ì—†ë‹¤ë©´ ì´ ë¶€ë¶„ì€ ìƒëµí•´ë„ ê´œì°®ìŠµë‹ˆë‹¤.
          echo "ğŸ”„ Nginx Restart: ì›¹ì„œë²„ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
          sudo systemctl restart nginx
          
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"