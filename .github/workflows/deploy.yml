name: Deploy to SIGNALCRAFT EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/smartcompressor-ai-system
          
          # Git pull ìµœì‹  ì½”ë“œ
          echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          git pull origin main
          
          # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm install
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘..."
          pkill -f "node server.js" || true
          pkill -f "node app.js" || true
          
          # ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸš€ ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          nohup node server.js > server.log 2>&1 &
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 5
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          ps aux | grep "node server.js" | grep -v grep
          
          # API í…ŒìŠ¤íŠ¸
          curl -s http://localhost:3000/api/auth/verify || echo "API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          
          echo "ğŸ‰ SIGNALCRAFT EC2 ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ ì„œë²„ URL: http://${{ secrets.EC2_HOST }}:3000"
