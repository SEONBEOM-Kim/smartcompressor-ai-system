<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 오디오 데이터 연구 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/waveform-data@4.3.0/dist/waveform-data.min.js"></script>
    <style>
        .audio-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .audio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .waveform-container {
            height: 100px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }
        .file-info {
            font-size: 0.9em;
            color: #6c757d;
        }
        .analysis-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-normal { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-microphone"></i> ESP32 오디오 연구 시스템
                        </a>
                        <button class="btn btn-outline-light" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> 새로고침
                        </button>
                    </div>
                </nav>
            </div>
        </div>

        <div class="row">
            <!-- 파일 목록 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> 업로드된 오디오 파일</h5>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="fileList" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">로딩 중...</span>
                            </div>
                            <p class="mt-2">파일 목록을 불러오는 중...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오디오 분석 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> 오디오 분석</h5>
                    </div>
                    <div class="card-body">
                        <!-- 파일이 선택되지 않은 경우 -->
                        <div id="noFileSelected" class="text-center text-muted">
                            <i class="fas fa-music fa-3x mb-3"></i>
                            <p>분석할 오디오 파일을 선택하세요</p>
                        </div>

                        <!-- 오디오 플레이어 -->
                        <div id="audioPlayer" style="display: none;">
                            <div class="mb-3">
                                <audio id="audioElement" controls class="w-100">
                                    <source id="audioSource" src="" type="audio/wav">
                                    브라우저가 오디오를 지원하지 않습니다.
                                </audio>
                            </div>

                            <!-- 파일 정보 -->
                            <div id="fileInfo" class="mb-3">
                                <!-- 파일 정보가 여기에 표시됩니다 -->
                            </div>

                            <!-- 웨이브폼 -->
                            <div class="waveform-container">
                                <canvas id="waveformCanvas" width="800" height="100"></canvas>
                            </div>

                            <!-- 분석 결과 -->
                            <div id="analysisResult" class="analysis-result">
                                <!-- 분석 결과가 여기에 표시됩니다 -->
                            </div>

                            <!-- 고급 분석 결과 -->
                            <div id="advancedAnalysis" style="display: none;">
                                <!-- 기본 특징 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-warning">기본 특징</h6>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>RMS 에너지:</strong> <span id="rmsValue">-</span></p>
                                        <p><strong>스펙트럼 중심:</strong> <span id="spectralCentroid">-</span></p>
                                        <p><strong>제로 크로싱 비율:</strong> <span id="zeroCrossingRate">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>압축기 상태:</strong> <span id="compressorState">-</span></p>
                                        <p><strong>이상 점수:</strong> <span id="anomalyScore">-</span></p>
                                        <p><strong>온도 추정:</strong> <span id="temperatureEstimate">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>효율성 점수:</strong> <span id="efficiencyScore">-</span></p>
                                        <p><strong>스펙트럼 롤오프:</strong> <span id="spectralRolloff">-</span></p>
                                    </div>
                                </div>
                                
                                <!-- 고급 스펙트럼 특징 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-info">고급 스펙트럼 특징</h6>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>스펙트럼 대역폭:</strong> <span id="spectralBandwidth">-</span></p>
                                        <p><strong>스펙트럼 대비:</strong> <span id="spectralContrast">-</span></p>
                                        <p><strong>스펙트럼 평탄도:</strong> <span id="spectralFlatness">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>스펙트럼 왜도:</strong> <span id="spectralSkewness">-</span></p>
                                        <p><strong>스펙트럼 첨도:</strong> <span id="spectralKurtosis">-</span></p>
                                        <p><strong>하모닉 비율:</strong> <span id="harmonicRatio">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>비하모닉성:</strong> <span id="inharmonicity">-</span></p>
                                    </div>
                                </div>
                                
                                <!-- ADSR 특징 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-success">ADSR 특징</h6>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Attack Time:</strong> <span id="attackTime">-</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Decay Time:</strong> <span id="decayTime">-</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Sustain Level:</strong> <span id="sustainLevel">-</span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Release Time:</strong> <span id="releaseTime">-</span></p>
                                    </div>
                                </div>
                                
                                <!-- 소리 분류 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-danger">소리 분류</h6>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>소리 유형:</strong> <span id="soundType">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>강도 레벨:</strong> <span id="intensityLevel">-</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <p><strong>주파수 지배도:</strong> <span id="frequencyDominance">-</span></p>
                                    </div>
                                </div>
                                
                                <!-- MFCC 계수 -->
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="text-primary">MFCC 계수 (0-12)</h6>
                                        <div id="mfccCoefficients" class="row">
                                            <!-- MFCC 계수들이 여기에 동적으로 추가됩니다 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 분석 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> 통계 분석</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="statisticsChart" width="400" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let audioFiles = [];
        let currentFile = null;
        let statisticsChart = null;

        // 페이지 로드 시 데이터 가져오기
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드됨 - 데이터 새로고침 시작');
            refreshData();
            initChart();
        });

        // 데이터 새로고침
        async function refreshData() {
            console.log('데이터 새로고침 시작...');
            try {
                const response = await fetch('/api/esp32/files');
                console.log('API 응답 상태:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                audioFiles = await response.json();
                console.log('로드된 파일 수:', audioFiles.length);
                displayFileList();
            } catch (error) {
                console.error('파일 목록 로드 실패:', error);
                document.getElementById('fileList').innerHTML =
                    '<div class="alert alert-danger">파일 목록을 불러올 수 없습니다.<br>오류: ' + error.message + '</div>';
            }
        }

        // 파일 목록 표시
        function displayFileList() {
            const fileList = document.getElementById('fileList');
            console.log('파일 목록 표시 중... 파일 수:', audioFiles.length);

            if (audioFiles.length === 0) {
                fileList.innerHTML = '<div class="text-center text-muted">업로드된 파일이 없습니다.</div>';
                return;
            }

            fileList.innerHTML = audioFiles.map(file => `
                <div class="list-group-item audio-card" onclick="selectFile('${file.name}')">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${file.name}</h6>
                        <small>${formatFileSize(file.size)}</small>
                    </div>
                    <p class="mb-1 file-info">
                        <i class="fas fa-clock"></i> ${formatDate(file.modified)}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Device: ${file.deviceId || 'Unknown'}</small>
                        <span class="badge ${getStatusBadgeClass(file.analysis)}">
                            ${file.analysis?.is_overload ? '이상' : '정상'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // 파일 선택
        function selectFile(fileName) {
            console.log('파일 선택됨:', fileName);
            currentFile = audioFiles.find(f => f.name === fileName);
            if (!currentFile) {
                console.error('파일을 찾을 수 없음:', fileName);
                return;
            }

            // 오디오 플레이어 표시
            document.getElementById('noFileSelected').style.display = 'none';
            document.getElementById('audioPlayer').style.display = 'block';

            // 오디오 소스 설정
            const audioElement = document.getElementById('audioElement');
            const audioSource = document.getElementById('audioSource');
            audioSource.src = `/uploads/esp32/${fileName}`;
            audioElement.load();

            // 파일 정보 표시
            displayFileInfo();
            
            // 분석 결과 표시
            displayAnalysisResult();
            
            // 웨이브폼 생성
            generateWaveform();
        }

        // 파일 정보 표시
        function displayFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <p><strong>파일명:</strong> ${currentFile.name}</p>
                <p><strong>크기:</strong> ${formatFileSize(currentFile.size)}</p>
                <p><strong>수정일:</strong> ${formatDate(currentFile.modified)}</p>
                <p><strong>디바이스:</strong> ${currentFile.deviceId || 'Unknown'}</p>
                <p><strong>샘플레이트:</strong> ${currentFile.sampleRate || 'Unknown'} Hz</p>
            `;
        }

        // 분석 결과 표시
        function displayAnalysisResult() {
            const analysisResult = document.getElementById('analysisResult');
            const analysis = currentFile.analysis || {};

            analysisResult.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-cog fa-spin"></i> 분석 중...
                </div>
            `;
            
            // 고급 분석 결과 표시
            setTimeout(() => {
                const advancedAnalysis = document.getElementById('advancedAnalysis');
                if (advancedAnalysis) {
                    advancedAnalysis.style.display = 'block';
                    
                    updateBasicFeatures(analysis);
                    updateAdvancedFeatures(analysis);
                    updateADSRFeatures(analysis);
                    updateSoundClassification(analysis);
                    updateMFCCCoefficients(analysis);
                }
            }, 1000);
        }

        // 기본 특징 업데이트
        function updateBasicFeatures(analysis) {
            document.getElementById('rmsValue').textContent = (analysis.rms_energy || 0).toFixed(2);
            document.getElementById('spectralCentroid').textContent = (analysis.spectral_centroid || 0).toFixed(3);
            document.getElementById('zeroCrossingRate').textContent = (analysis.zero_crossing_rate || 0).toFixed(3);
            document.getElementById('compressorState').textContent = (analysis.compressor_state > 0.5) ? 'ON' : 'OFF';
            document.getElementById('anomalyScore').textContent = (analysis.anomaly_score || 0).toFixed(3);
            document.getElementById('temperatureEstimate').textContent = (analysis.temperature_estimate || 0).toFixed(1) + '°C';
            document.getElementById('efficiencyScore').textContent = (analysis.efficiency_score || 0).toFixed(3);
            document.getElementById('spectralRolloff').textContent = (analysis.spectral_rolloff || 0).toFixed(3);
        }

        // 고급 특징 업데이트
        function updateAdvancedFeatures(analysis) {
            document.getElementById('spectralBandwidth').textContent = (analysis.spectral_bandwidth || 0).toFixed(2);
            document.getElementById('spectralContrast').textContent = (analysis.spectral_contrast || 0).toFixed(4);
            document.getElementById('spectralFlatness').textContent = (analysis.spectral_flatness || 0).toFixed(4);
            document.getElementById('spectralSkewness').textContent = (analysis.spectral_skewness || 0).toFixed(4);
            document.getElementById('spectralKurtosis').textContent = (analysis.spectral_kurtosis || 0).toFixed(4);
            document.getElementById('harmonicRatio').textContent = (analysis.harmonic_ratio || 0).toFixed(4);
            document.getElementById('inharmonicity').textContent = (analysis.inharmonicity || 0).toFixed(4);
        }

        // ADSR 특징 업데이트
        function updateADSRFeatures(analysis) {
            document.getElementById('attackTime').textContent = (analysis.attack_time || 0).toFixed(4);
            document.getElementById('decayTime').textContent = (analysis.decay_time || 0).toFixed(4);
            document.getElementById('sustainLevel').textContent = (analysis.sustain_level || 0).toFixed(4);
            document.getElementById('releaseTime').textContent = (analysis.release_time || 0).toFixed(4);
        }

        // 소리 분류 업데이트
        function updateSoundClassification(analysis) {
            const soundType = analysis.sound_type || 0;
            const soundTypeNames = ['정적', '압축기', '팬', '이상음', '기타'];
            const soundTypeName = soundTypeNames[Math.round(soundType)] || '알 수 없음';
            
            document.getElementById('soundType').textContent = soundTypeName;
            document.getElementById('intensityLevel').textContent = ((analysis.intensity_level || 0) * 100).toFixed(1) + '%';
            document.getElementById('frequencyDominance').textContent = (analysis.frequency_dominance || 0).toFixed(3);
        }

        // MFCC 계수 업데이트
        function updateMFCCCoefficients(analysis) {
            const mfccContainer = document.getElementById('mfccCoefficients');
            const mfcc = analysis.mfcc || [];
            
            mfccContainer.innerHTML = '';
            for (let i = 0; i < 13; i++) {
                const col = document.createElement('div');
                col.className = 'col-md-1';
                col.innerHTML = `
                    <div class="text-center">
                        <small class="text-muted">C${i}</small><br>
                        <strong>${(mfcc[i] || 0).toFixed(3)}</strong>
                    </div>
                `;
                mfccContainer.appendChild(col);
            }
        }

        // 웨이브폼 생성
        function generateWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');

            // 간단한 웨이브폼 시뮬레이션
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;

            ctx.beginPath();
            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + Math.sin(x * 0.02) * 20 + Math.random() * 10 - 5;
                if (x === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
        }

        // 통계 차트 초기화
        function initChart() {
            const ctx = document.getElementById('statisticsChart').getContext('2d');
            statisticsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'dB 레벨',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 유틸리티 함수들
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('ko-KR');
        }

        function getStatusBadgeClass(analysis) {
            if (!analysis) return 'bg-secondary';
            return analysis.is_overload ? 'bg-danger' : 'bg-success';
        }
    </script>
</body>
</html>
