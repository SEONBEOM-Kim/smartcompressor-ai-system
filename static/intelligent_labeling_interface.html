<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏßÄÎä•Ìòï AI Îç∞Ïù¥ÌÑ∞ ÎùºÎ≤®ÎßÅ ÏãúÏä§ÌÖú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2E86AB;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2E86AB;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
        }

        .section h2 {
            color: #2E86AB;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #f0f4ff;
        }

        .file-item.selected {
            background: #e8f4f8;
            border-left: 4px solid #2E86AB;
        }

        .file-item.processed {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .file-meta {
            color: #666;
            font-size: 0.9rem;
        }

        .file-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-ready {
            background: #fff3cd;
            color: #856404;
        }

        .status-processed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #f8d7da;
            color: #721c24;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
            border: 2px solid #2E86AB;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-suggestion h3 {
            color: #2E86AB;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .suggestion-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2E86AB;
        }

        .suggestion-item h4 {
            color: #2E86AB;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .suggestion-item .value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .confidence-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            transition: width 0.3s ease;
        }

        .uncertainty-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .uncertainty-low {
            background: #d4edda;
            color: #155724;
        }

        .uncertainty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .uncertainty-high {
            background: #f8d7da;
            color: #721c24;
        }

        .reasoning-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
        }

        .reasoning-box h4 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .reasoning-text {
            color: #666;
            line-height: 1.5;
        }

        .audio-player {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .audio-player h3 {
            color: #2E86AB;
            margin-bottom: 15px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .play-btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .play-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            color: #666;
            font-size: 0.9rem;
        }

        .labeling-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .label-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .label-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            position: relative;
        }

        .label-btn:hover {
            border-color: #2E86AB;
            background: #f0f4ff;
        }

        .label-btn.selected {
            border-color: #2E86AB;
            background: #e8f4f8;
            color: #2E86AB;
        }

        .label-btn.ai-suggested {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .label-btn.ai-suggested::after {
            content: "ü§ñ AI Ï†úÏïà";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .label-btn.normal {
            border-color: #28a745;
        }

        .label-btn.normal.selected {
            background: #d4edda;
            color: #155724;
        }

        .label-btn.warning {
            border-color: #ffc107;
        }

        .label-btn.warning.selected {
            background: #fff3cd;
            color: #856404;
        }

        .label-btn.critical {
            border-color: #dc3545;
        }

        .label-btn.critical.selected {
            background: #f8d7da;
            color: #721c24;
        }

        .label-btn.unknown {
            border-color: #6c757d;
        }

        .label-btn.unknown.selected {
            background: #e2e3e5;
            color: #383d41;
        }

        .confidence-slider {
            margin: 15px 0;
        }

        .confidence-value {
            text-align: center;
            font-weight: bold;
            color: #2E86AB;
            margin-top: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-accept-ai {
            background: #28a745;
        }

        .no-files {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .loading {
            text-align: center;
            color: #2E86AB;
            padding: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .indicator-ready { background: #ffc107; }
        .indicator-processed { background: #28a745; }
        .indicator-pending { background: #dc3545; }

        .ai-accuracy {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2E86AB;
        }

        .ai-accuracy h4 {
            color: #2E86AB;
            margin-bottom: 10px;
        }

        .accuracy-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .accuracy-item {
            text-align: center;
        }

        .accuracy-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2E86AB;
        }

        .accuracy-label {
            font-size: 0.8rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .label-buttons {
                grid-template-columns: 1fr;
            }

            .suggestion-content {
                grid-template-columns: 1fr;
            }

            .accuracy-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† ÏßÄÎä•Ìòï AI Îç∞Ïù¥ÌÑ∞ ÎùºÎ≤®ÎßÅ ÏãúÏä§ÌÖú</h1>
            <p>AIÍ∞Ä ÎùºÎ≤®ÏùÑ Ï†úÏïàÌïòÍ≥† Ï†ÑÎ¨∏Í∞ÄÍ∞Ä Í≤ÄÏ¶ùÌïòÎäî ÏãúÏä§ÌÖú</p>
        </div>

        <div class="content">
            <!-- ÌÜµÍ≥Ñ Î∞î -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">Ï†ÑÏ≤¥ ÌååÏùº</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="readyFiles">0</div>
                    <div class="stat-label">ÎùºÎ≤®ÎßÅ ÎåÄÍ∏∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="processedFiles">0</div>
                    <div class="stat-label">ÎùºÎ≤®ÎßÅ ÏôÑÎ£å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="aiAccuracy">0%</div>
                    <div class="stat-label">AI Ï†ïÌôïÎèÑ</div>
                </div>
            </div>

            <div class="main-content">
                <!-- ÌååÏùº Î™©Î°ù -->
                <div class="section">
                    <h2>üìÅ ÎùºÎ≤®ÎßÅ ÌååÏùº Î™©Î°ù</h2>
                    <div class="file-list" id="fileList">
                        <div class="loading">ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                    </div>
                </div>

                <!-- ÎùºÎ≤®ÎßÅ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
                <div class="section">
                    <h2>üéµ ÏßÄÎä•Ìòï Ïò§ÎîîÏò§ ÎùºÎ≤®ÎßÅ</h2>
                    
                    <!-- AI Ï†ïÌôïÎèÑ ÌëúÏãú -->
                    <div class="ai-accuracy" id="aiAccuracyBox" style="display: none;">
                        <h4>ü§ñ AI ÏÑ±Îä• ÏßÄÌëú</h4>
                        <div class="accuracy-stats">
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="agreementRate">0%</div>
                                <div class="accuracy-label">ÏùºÏπòÏú®</div>
                            </div>
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="avgConfidence">0%</div>
                                <div class="accuracy-label">ÌèâÍ∑† Ïã†Î¢∞ÎèÑ</div>
                            </div>
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="totalDecisions">0</div>
                                <div class="accuracy-label">Ï¥ù Í≤∞Ï†ï Ïàò</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Ï†úÏïà -->
                    <div class="ai-suggestion" id="aiSuggestion" style="display: none;">
                        <h3>ü§ñ AI ÎùºÎ≤® Ï†úÏïà</h3>
                        <div class="suggestion-content">
                            <div class="suggestion-item">
                                <h4>Ï†úÏïà ÎùºÎ≤®</h4>
                                <div class="value" id="suggestedLabel">-</div>
                            </div>
                            <div class="suggestion-item">
                                <h4>Ïã†Î¢∞ÎèÑ</h4>
                                <div class="value" id="suggestedConfidence">-</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="confidenceBar"></div>
                                </div>
                            </div>
                            <div class="suggestion-item">
                                <h4>Î∂àÌôïÏã§ÏÑ±</h4>
                                <div class="value" id="uncertainty">-</div>
                                <div class="uncertainty-indicator" id="uncertaintyIndicator">-</div>
                            </div>
                            <div class="suggestion-item">
                                <h4>Ï†úÏïà ÌÉÄÏûÖ</h4>
                                <div class="value" id="suggestionType">-</div>
                            </div>
                        </div>
                        <div class="reasoning-box">
                            <h4>üß† AI Ï∂îÎ°† Í≥ºÏ†ï</h4>
                            <div class="reasoning-text" id="reasoningText">-</div>
                        </div>
                    </div>

                    <!-- Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ -->
                    <div class="audio-player" id="audioPlayer" style="display: none;">
                        <h3 id="currentFileName">ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h3>
                        <div class="audio-controls">
                            <button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂Ô∏è Ïû¨ÏÉù</button>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                        </div>
                        <audio id="audioElement" preload="metadata"></audio>
                    </div>

                    <!-- ÎùºÎ≤®ÎßÅ Ìèº -->
                    <div class="labeling-form" id="labelingForm" style="display: none;">
                        <div class="form-group">
                            <label>ÎùºÎ≤® ÏÑ†ÌÉù</label>
                            <div class="label-buttons">
                                <button class="label-btn normal" data-label="normal" onclick="selectLabel('normal')">
                                    ‚úÖ Ï†ïÏÉÅ
                                </button>
                                <button class="label-btn warning" data-label="warning" onclick="selectLabel('warning')">
                                    ‚ö†Ô∏è Í≤ΩÍ≥†
                                </button>
                                <button class="label-btn critical" data-label="critical" onclick="selectLabel('critical')">
                                    üö® ÏúÑÌóò
                                </button>
                                <button class="label-btn unknown" data-label="unknown" onclick="selectLabel('unknown')">
                                    ‚ùì ÎØ∏Î∂ÑÎ•ò
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Ïã†Î¢∞ÎèÑ: <span id="confidenceValue">50</span>%</label>
                            <input type="range" id="confidenceSlider" min="0" max="100" value="50" 
                                   class="confidence-slider" oninput="updateConfidence(this.value)">
                        </div>

                        <div class="form-group">
                            <label>Î©îÎ™® (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                            <textarea id="notesInput" placeholder="ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Ï∂îÍ∞Ä Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-accept-ai" onclick="acceptAISuggestion()" id="acceptAIBtn" style="display: none;">
                                ü§ñ AI Ï†úÏïà ÏàòÎùΩ
                            </button>
                            <button class="btn btn-secondary" onclick="skipFile()">Í±¥ÎÑàÎõ∞Í∏∞</button>
                            <button class="btn" onclick="saveLabel()" id="saveBtn">ÎùºÎ≤® Ï†ÄÏû•</button>
                        </div>
                    </div>

                    <div id="noFileSelected" class="no-files">
                        ÎùºÎ≤®ÎßÅÌï† ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentFile = null;
        let currentAudio = null;
        let isPlaying = false;
        let selectedLabel = null;
        let labelingData = [];
        let aiSuggestion = null;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            loadLabelingData();
            loadStats();
            loadAIPerformance();
            
            // 30Ï¥àÎßàÎã§ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
            setInterval(() => {
                loadLabelingData();
                loadStats();
                loadAIPerformance();
            }, 30000);
        });

        // ÎùºÎ≤®ÎßÅ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadLabelingData() {
            try {
                const response = await fetch('/api/labeling/data');
                const result = await response.json();

                if (result.success) {
                    labelingData = result.data || [];
                    displayFileList();
                }
            } catch (error) {
                console.error('ÎùºÎ≤®ÎßÅ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÌÜµÍ≥Ñ Î°úÎìú
        async function loadStats() {
            try {
                const response = await fetch('/api/labeling/stats');
                const result = await response.json();

                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('totalFiles').textContent = stats.total;
                    document.getElementById('readyFiles').textContent = stats.ready;
                    document.getElementById('processedFiles').textContent = stats.labeled;
                    
                    const progress = stats.total > 0 ? Math.round((stats.labeled / stats.total) * 100) : 0;
                    document.getElementById('aiAccuracy').textContent = progress + '%';
                }
            } catch (error) {
                console.error('ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // AI ÏÑ±Îä• Î°úÎìú
        async function loadAIPerformance() {
            try {
                const response = await fetch('/api/labeling/ai-performance');
                const result = await response.json();

                if (result.success) {
                    const performance = result.performance;
                    document.getElementById('agreementRate').textContent = Math.round(performance.agreement_rate * 100) + '%';
                    document.getElementById('avgConfidence').textContent = Math.round(performance.average_confidence * 100) + '%';
                    document.getElementById('totalDecisions').textContent = performance.total_decisions;
                    
                    document.getElementById('aiAccuracyBox').style.display = 'block';
                }
            } catch (error) {
                console.error('AI ÏÑ±Îä• Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ÌååÏùº Î™©Î°ù ÌëúÏãú
        function displayFileList() {
            const container = document.getElementById('fileList');
            
            if (labelingData.length === 0) {
                container.innerHTML = '<div class="no-files">ÎùºÎ≤®ÎßÅÌï† ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.<br>Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÏóêÏÑú Ï¶ùÍ∞ïÏùÑ Ïã§ÌñâÌïòÏÑ∏Ïöî.</div>';
                return;
            }

            // ÏÉÅÌÉúÎ≥ÑÎ°ú Ï†ïÎ†¨ (ÎØ∏Ï≤òÎ¶¨ Ïö∞ÏÑ†)
            const sortedData = labelingData.sort((a, b) => {
                if (a.status === 'ready_for_labeling' && b.status !== 'ready_for_labeling') return -1;
                if (a.status !== 'ready_for_labeling' && b.status === 'ready_for_labeling') return 1;
                return new Date(b.createdTime || b.timestamp) - new Date(a.createdTime || a.timestamp);
            });

            container.innerHTML = sortedData.map(item => {
                const statusClass = item.status === 'labeled' ? 'processed' : 'ready';
                const statusText = item.status === 'labeled' ? 'ÏôÑÎ£å' : 'ÎåÄÍ∏∞';
                const statusIndicator = item.status === 'labeled' ? 'indicator-processed' : 'indicator-ready';
                
                return `
                    <div class="file-item ${statusClass} ${currentFile && currentFile.id === item.id ? 'selected' : ''}" 
                         onclick="selectFile(${item.id})">
                        <div class="file-info">
                            <div class="file-name">${item.fileName}</div>
                            <div class="file-meta">
                                <span class="status-indicator ${statusIndicator}"></span>
                                ${statusText} ‚Ä¢ 
                                ${formatFileSize(item.fileSize)} ‚Ä¢ 
                                ${formatDate(item.createdTime || item.timestamp)}
                                ${item.label ? `‚Ä¢ ÎùºÎ≤®: ${item.label}` : ''}
                            </div>
                        </div>
                        <div class="file-status status-${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        // ÌååÏùº ÏÑ†ÌÉù
        async function selectFile(fileId) {
            const file = labelingData.find(item => item.id === fileId);
            if (!file) return;

            currentFile = file;
            displayFileList(); // ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏

            // Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥Ïñ¥ ÌëúÏãú
            document.getElementById('audioPlayer').style.display = 'block';
            document.getElementById('labelingForm').style.display = 'block';
            document.getElementById('noFileSelected').style.display = 'none';

            // ÌååÏùº Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('currentFileName').textContent = file.fileName;
            
            // Ïò§ÎîîÏò§ ÏÑ§Ï†ï
            const audioElement = document.getElementById('audioElement');
            audioElement.src = `/api/audio/${encodeURIComponent(file.fileName)}`;
            
            // AI Ï†úÏïà ÏöîÏ≤≠
            await requestAISuggestion(file.fileName);
            
            // Í∏∞Ï°¥ ÎùºÎ≤® Ï†ïÎ≥¥ ÌëúÏãú
            if (file.label) {
                selectLabel(file.label);
                document.getElementById('confidenceSlider').value = file.confidence || 50;
                updateConfidence(file.confidence || 50);
                document.getElementById('notesInput').value = file.notes || '';
            } else {
                // Ï¥àÍ∏∞Ìôî
                document.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
                selectedLabel = null;
                document.getElementById('confidenceSlider').value = 50;
                updateConfidence(50);
                document.getElementById('notesInput').value = '';
            }
        }

        // AI Ï†úÏïà ÏöîÏ≤≠
        async function requestAISuggestion(fileName) {
            try {
                const response = await fetch('/api/labeling/ai-suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: fileName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    aiSuggestion = result.suggestion;
                    displayAISuggestion(aiSuggestion);
                } else {
                    console.error('AI Ï†úÏïà ÏöîÏ≤≠ Ïã§Ìå®:', result.message);
                }
            } catch (error) {
                console.error('AI Ï†úÏïà ÏöîÏ≤≠ Ïò§Î•ò:', error);
            }
        }

        // AI Ï†úÏïà ÌëúÏãú
        function displayAISuggestion(suggestion) {
            document.getElementById('aiSuggestion').style.display = 'block';
            
            // Ï†úÏïà Ï†ïÎ≥¥ ÌëúÏãú
            document.getElementById('suggestedLabel').textContent = suggestion.suggested_label;
            document.getElementById('suggestedConfidence').textContent = Math.round(suggestion.confidence * 100) + '%';
            document.getElementById('uncertainty').textContent = Math.round(suggestion.uncertainty * 100) + '%';
            document.getElementById('suggestionType').textContent = suggestion.suggestion_type;
            document.getElementById('reasoningText').textContent = suggestion.reasoning;
            
            // Ïã†Î¢∞ÎèÑ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = (suggestion.confidence * 100) + '%';
            
            // Î∂àÌôïÏã§ÏÑ± ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const uncertaintyIndicator = document.getElementById('uncertaintyIndicator');
            if (suggestion.uncertainty < 0.3) {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-low';
                uncertaintyIndicator.textContent = 'ÎÇÆÏùå';
            } else if (suggestion.uncertainty < 0.7) {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-medium';
                uncertaintyIndicator.textContent = 'Î≥¥ÌÜµ';
            } else {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-high';
                uncertaintyIndicator.textContent = 'ÎÜíÏùå';
            }
            
            // AI Ï†úÏïà ÏàòÎùΩ Î≤ÑÌäº ÌëúÏãú
            if (suggestion.requires_human_review) {
                document.getElementById('acceptAIBtn').style.display = 'none';
            } else {
                document.getElementById('acceptAIBtn').style.display = 'block';
            }
        }

        // AI Ï†úÏïà ÏàòÎùΩ
        function acceptAISuggestion() {
            if (!aiSuggestion) return;
            
            // AI Ï†úÏïàÏùÑ Í∏∞Î∞òÏúºÎ°ú ÎùºÎ≤® ÏÑ§Ï†ï
            const suggestedLabel = aiSuggestion.suggested_label;
            const suggestedConfidence = Math.round(aiSuggestion.confidence * 100);
            
            // ÎùºÎ≤® Îß§Ìïë
            const labelMapping = {
                'normal_compressor': 'normal',
                'normal_fan': 'normal',
                'normal_motor': 'normal',
                'abnormal_bearing': 'critical',
                'abnormal_unbalance': 'warning',
                'abnormal_friction': 'warning',
                'abnormal_overload': 'critical'
            };
            
            const mappedLabel = labelMapping[suggestedLabel] || 'unknown';
            
            // ÎùºÎ≤® ÏÑ†ÌÉù
            selectLabel(mappedLabel);
            
            // Ïã†Î¢∞ÎèÑ ÏÑ§Ï†ï
            document.getElementById('confidenceSlider').value = suggestedConfidence;
            updateConfidence(suggestedConfidence);
            
            // AI Ï†úÏïà ÏàòÎùΩ ÌëúÏãú
            const selectedBtn = document.querySelector(`[data-label="${mappedLabel}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('ai-suggested');
            }
            
            alert('AI Ï†úÏïàÏù¥ ÏàòÎùΩÎêòÏóàÏäµÎãàÎã§. ÌïÑÏöîÏãú ÏàòÏ†ï ÌõÑ Ï†ÄÏû•ÌïòÏÑ∏Ïöî.');
        }

        // ÎùºÎ≤® ÏÑ†ÌÉù
        function selectLabel(label) {
            selectedLabel = label;
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('selected', 'ai-suggested');
                if (btn.dataset.label === label) {
                    btn.classList.add('selected');
                }
            });
        }

        // Ïã†Î¢∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateConfidence(value) {
            document.getElementById('confidenceValue').textContent = value;
        }

        // Ïò§ÎîîÏò§ Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ
        function togglePlay() {
            const audio = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                audio.pause();
                playBtn.textContent = '‚ñ∂Ô∏è Ïû¨ÏÉù';
                isPlaying = false;
            } else {
                audio.play();
                playBtn.textContent = '‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ';
                isPlaying = true;
            }
        }

        // Ïò§ÎîîÏò§ ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('audioElement').addEventListener('timeupdate', function() {
            const audio = this;
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            const currentTime = formatTime(audio.currentTime);
            const duration = formatTime(audio.duration);
            document.getElementById('timeDisplay').textContent = `${currentTime} / ${duration}`;
        });

        // Ïò§ÎîîÏò§ Ï¢ÖÎ£å Ïãú
        document.getElementById('audioElement').addEventListener('ended', function() {
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Ïû¨ÏÉù';
            isPlaying = false;
        });

        // Ïò§ÎîîÏò§ Ïò§Î•ò Ï≤òÎ¶¨
        document.getElementById('audioElement').addEventListener('error', function(e) {
            console.error('Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:', e);
            document.getElementById('playBtn').textContent = '‚ùå Ïû¨ÏÉù Î∂àÍ∞Ä';
            document.getElementById('playBtn').disabled = true;
            alert('Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ïû¨ÏÉùÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌååÏùºÏù¥ ÏÜêÏÉÅÎêòÏóàÍ±∞ÎÇò ÏßÄÏõêÎêòÏßÄ ÏïäÎäî ÌòïÏãùÏùº Ïàò ÏûàÏäµÎãàÎã§.');
        });

        // Ïò§ÎîîÏò§ Î°úÎìú ÏôÑÎ£å Ïãú
        document.getElementById('audioElement').addEventListener('loadeddata', function() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Ïû¨ÏÉù';
        });

        // ÎùºÎ≤® Ï†ÄÏû•
        async function saveLabel() {
            if (!currentFile || !selectedLabel) {
                alert('ÎùºÎ≤®ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const confidence = parseInt(document.getElementById('confidenceSlider').value);
            const notes = document.getElementById('notesInput').value;

            try {
                const response = await fetch('/api/labeling/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: currentFile.fileName,
                        label: selectedLabel,
                        confidence: confidence,
                        notes: notes,
                        labelerId: 'user_' + Date.now(),
                        aiSuggestion: aiSuggestion
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    const index = labelingData.findIndex(item => item.id === currentFile.id);
                    if (index >= 0) {
                        labelingData[index] = { ...labelingData[index], ...result.data };
                    }
                    
                    displayFileList();
                    loadStats();
                    loadAIPerformance();
                    
                    alert('ÎùºÎ≤®Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    
                    // Îã§Ïùå ÌååÏùºÏúºÎ°ú ÏûêÎèô Ïù¥Îèô
                    const nextFile = labelingData.find(item => item.status === 'ready_for_labeling');
                    if (nextFile) {
                        selectFile(nextFile.id);
                    }
                } else {
                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + result.message);
                }
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // ÌååÏùº Í±¥ÎÑàÎõ∞Í∏∞
        function skipFile() {
            if (currentFile) {
                const nextFile = labelingData.find(item => 
                    item.id !== currentFile.id && item.status === 'ready_for_labeling'
                );
                if (nextFile) {
                    selectFile(nextFile.id);
                } else {
                    alert('Îçî Ïù¥ÏÉÅ ÎùºÎ≤®ÎßÅÌï† ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.');
                }
            }
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR');
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
