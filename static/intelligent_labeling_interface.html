<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ëŠ¥í˜• AI ë°ì´í„° ë¼ë²¨ë§ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2E86AB;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2E86AB;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
        }

        .section h2 {
            color: #2E86AB;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #f0f4ff;
        }

        .file-item.selected {
            background: #e8f4f8;
            border-left: 4px solid #2E86AB;
        }

        .file-item.processed {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .file-meta {
            color: #666;
            font-size: 0.9rem;
        }

        .file-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-ready {
            background: #fff3cd;
            color: #856404;
        }

        .status-processed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #f8d7da;
            color: #721c24;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
            border: 2px solid #2E86AB;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-suggestion h3 {
            color: #2E86AB;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .suggestion-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2E86AB;
        }

        .suggestion-item h4 {
            color: #2E86AB;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .suggestion-item .value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .confidence-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            transition: width 0.3s ease;
        }

        .uncertainty-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .uncertainty-low {
            background: #d4edda;
            color: #155724;
        }

        .uncertainty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .uncertainty-high {
            background: #f8d7da;
            color: #721c24;
        }

        .reasoning-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
        }

        .reasoning-box h4 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .reasoning-text {
            color: #666;
            line-height: 1.5;
        }

        .audio-player {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .audio-player h3 {
            color: #2E86AB;
            margin-bottom: 15px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .play-btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .play-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            width: 0%;
            transition: width 0.1s ease;
        }

        .time-display {
            color: #666;
            font-size: 0.9rem;
        }

        .labeling-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .label-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .label-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            position: relative;
        }

        .label-btn:hover {
            border-color: #2E86AB;
            background: #f0f4ff;
        }

        .label-btn.selected {
            border-color: #2E86AB;
            background: #e8f4f8;
            color: #2E86AB;
        }

        .label-btn.ai-suggested {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .label-btn.ai-suggested::after {
            content: "ğŸ¤– AI ì œì•ˆ";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .label-btn.normal {
            border-color: #28a745;
        }

        .label-btn.normal.selected {
            background: #d4edda;
            color: #155724;
        }

        .label-btn.warning {
            border-color: #ffc107;
        }

        .label-btn.warning.selected {
            background: #fff3cd;
            color: #856404;
        }

        .label-btn.critical {
            border-color: #dc3545;
        }

        .label-btn.critical.selected {
            background: #f8d7da;
            color: #721c24;
        }

        .label-btn.unknown {
            border-color: #6c757d;
        }

        .label-btn.unknown.selected {
            background: #e2e3e5;
            color: #383d41;
        }

        .confidence-slider {
            margin: 15px 0;
        }

        .confidence-value {
            text-align: center;
            font-weight: bold;
            color: #2E86AB;
            margin-top: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-accept-ai {
            background: #28a745;
        }

        .no-files {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .loading {
            text-align: center;
            color: #2E86AB;
            padding: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .indicator-ready { background: #ffc107; }
        .indicator-processed { background: #28a745; }
        .indicator-pending { background: #dc3545; }

        .ai-accuracy {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2E86AB;
        }

        .ai-accuracy h4 {
            color: #2E86AB;
            margin-bottom: 10px;
        }

        .accuracy-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .accuracy-item {
            text-align: center;
        }

        .accuracy-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2E86AB;
        }

        .accuracy-label {
            font-size: 0.8rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .label-buttons {
                grid-template-columns: 1fr;
            }

            .suggestion-content {
                grid-template-columns: 1fr;
            }

            .accuracy-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  ì§€ëŠ¥í˜• AI ë°ì´í„° ë¼ë²¨ë§ ì‹œìŠ¤í…œ</h1>
            <p>AIê°€ ë¼ë²¨ì„ ì œì•ˆí•˜ê³  ì „ë¬¸ê°€ê°€ ê²€ì¦í•˜ëŠ” ì‹œìŠ¤í…œ</p>
        </div>

        <div class="content">
            <!-- í†µê³„ ë°” -->
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">ì „ì²´ íŒŒì¼</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="readyFiles">0</div>
                    <div class="stat-label">ë¼ë²¨ë§ ëŒ€ê¸°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="processedFiles">0</div>
                    <div class="stat-label">ë¼ë²¨ë§ ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="aiAccuracy">0%</div>
                    <div class="stat-label">AI ì •í™•ë„</div>
                </div>
            </div>

            <div class="main-content">
                <!-- íŒŒì¼ ëª©ë¡ -->
                <div class="section">
                    <h2>ğŸ“ ë¼ë²¨ë§ íŒŒì¼ ëª©ë¡</h2>
                    <div class="file-list" id="fileList">
                        <div class="loading">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ë¼ë²¨ë§ ì¸í„°í˜ì´ìŠ¤ -->
                <div class="section">
                    <h2>ğŸµ ì§€ëŠ¥í˜• ì˜¤ë””ì˜¤ ë¼ë²¨ë§</h2>
                    
                    <!-- AI ì •í™•ë„ í‘œì‹œ -->
                    <div class="ai-accuracy" id="aiAccuracyBox" style="display: none;">
                        <h4>ğŸ¤– AI ì„±ëŠ¥ ì§€í‘œ</h4>
                        <div class="accuracy-stats">
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="agreementRate">0%</div>
                                <div class="accuracy-label">ì¼ì¹˜ìœ¨</div>
                            </div>
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="avgConfidence">0%</div>
                                <div class="accuracy-label">í‰ê·  ì‹ ë¢°ë„</div>
                            </div>
                            <div class="accuracy-item">
                                <div class="accuracy-value" id="totalDecisions">0</div>
                                <div class="accuracy-label">ì´ ê²°ì • ìˆ˜</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI ì œì•ˆ -->
                    <div class="ai-suggestion" id="aiSuggestion" style="display: none;">
                        <h3>ğŸ¤– AI ë¼ë²¨ ì œì•ˆ</h3>
                        <div class="suggestion-content">
                            <div class="suggestion-item">
                                <h4>ì œì•ˆ ë¼ë²¨</h4>
                                <div class="value" id="suggestedLabel">-</div>
                            </div>
                            <div class="suggestion-item">
                                <h4>ì‹ ë¢°ë„</h4>
                                <div class="value" id="suggestedConfidence">-</div>
                                <div class="confidence-bar">
                                    <div class="confidence-fill" id="confidenceBar"></div>
                                </div>
                            </div>
                            <div class="suggestion-item">
                                <h4>ë¶ˆí™•ì‹¤ì„±</h4>
                                <div class="value" id="uncertainty">-</div>
                                <div class="uncertainty-indicator" id="uncertaintyIndicator">-</div>
                            </div>
                            <div class="suggestion-item">
                                <h4>ì œì•ˆ íƒ€ì…</h4>
                                <div class="value" id="suggestionType">-</div>
                            </div>
                        </div>
                        <div class="reasoning-box">
                            <h4>ğŸ§  AI ì¶”ë¡  ê³¼ì •</h4>
                            <div class="reasoning-text" id="reasoningText">-</div>
                        </div>
                    </div>

                    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ -->
                    <div class="audio-player" id="audioPlayer" style="display: none;">
                        <h3 id="currentFileName">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</h3>
                        <div class="audio-controls">
                            <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶ï¸ ì¬ìƒ</button>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                        </div>
                        <audio id="audioElement" preload="metadata"></audio>
                    </div>

                    <!-- ë¼ë²¨ë§ í¼ -->
                    <div class="labeling-form" id="labelingForm" style="display: none;">
                        <div class="form-group">
                            <label>ë¼ë²¨ ì„ íƒ</label>
                            <div class="label-buttons">
                                <button class="label-btn normal" data-label="normal" onclick="selectLabel('normal')">
                                    âœ… ì •ìƒ
                                </button>
                                <button class="label-btn warning" data-label="warning" onclick="selectLabel('warning')">
                                    âš ï¸ ê²½ê³ 
                                </button>
                                <button class="label-btn critical" data-label="critical" onclick="selectLabel('critical')">
                                    ğŸš¨ ìœ„í—˜
                                </button>
                                <button class="label-btn unknown" data-label="unknown" onclick="selectLabel('unknown')">
                                    â“ ë¯¸ë¶„ë¥˜
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ì‹ ë¢°ë„: <span id="confidenceValue">50</span>%</label>
                            <input type="range" id="confidenceSlider" min="0" max="100" value="50" 
                                   class="confidence-slider" oninput="updateConfidence(this.value)">
                        </div>

                        <div class="form-group">
                            <label>ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                            <textarea id="notesInput" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-accept-ai" onclick="acceptAISuggestion()" id="acceptAIBtn" style="display: none;">
                                ğŸ¤– AI ì œì•ˆ ìˆ˜ë½
                            </button>
                            <button class="btn btn-secondary" onclick="skipFile()">ê±´ë„ˆë›°ê¸°</button>
                            <button class="btn" onclick="saveLabel()" id="saveBtn">ë¼ë²¨ ì €ì¥</button>
                        </div>
                    </div>

                    <div id="noFileSelected" class="no-files">
                        ë¼ë²¨ë§í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentFile = null;
        let currentAudio = null;
        let isPlaying = false;
        let selectedLabel = null;
        let labelingData = [];
        let aiSuggestion = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadLabelingData();
            loadStats();
            loadAIPerformance();
            
            // 30ì´ˆë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            setInterval(() => {
                loadLabelingData();
                loadStats();
                loadAIPerformance();
            }, 30000);
        });

        // ë¼ë²¨ë§ ë°ì´í„° ë¡œë“œ
        async function loadLabelingData() {
            try {
                const response = await fetch('/api/labeling/data');
                const result = await response.json();

                if (result.success) {
                    labelingData = result.data || [];
                    displayFileList();
                }
            } catch (error) {
                console.error('ë¼ë²¨ë§ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch('/api/labeling/stats');
                const result = await response.json();

                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('totalFiles').textContent = stats.total;
                    document.getElementById('readyFiles').textContent = stats.ready;
                    document.getElementById('processedFiles').textContent = stats.labeled;
                    
                    const progress = stats.total > 0 ? Math.round((stats.labeled / stats.total) * 100) : 0;
                    document.getElementById('aiAccuracy').textContent = progress + '%';
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // AI ì„±ëŠ¥ ë¡œë“œ
        async function loadAIPerformance() {
            try {
                const response = await fetch('/api/labeling/ai-performance');
                const result = await response.json();

                if (result.success) {
                    const performance = result.performance;
                    document.getElementById('agreementRate').textContent = Math.round(performance.agreement_rate * 100) + '%';
                    document.getElementById('avgConfidence').textContent = Math.round(performance.average_confidence * 100) + '%';
                    document.getElementById('totalDecisions').textContent = performance.total_decisions;
                    
                    document.getElementById('aiAccuracyBox').style.display = 'block';
                }
            } catch (error) {
                console.error('AI ì„±ëŠ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displayFileList() {
            const container = document.getElementById('fileList');
            
            if (labelingData.length === 0) {
                container.innerHTML = '<div class="no-files">ë¼ë²¨ë§í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë°ì´í„° ì—…ë¡œë“œ í˜ì´ì§€ì—ì„œ ì¦ê°•ì„ ì‹¤í–‰í•˜ì„¸ìš”.</div>';
                return;
            }

            // ìƒíƒœë³„ë¡œ ì •ë ¬ (ë¯¸ì²˜ë¦¬ ìš°ì„ )
            const sortedData = labelingData.sort((a, b) => {
                if (a.status === 'ready_for_labeling' && b.status !== 'ready_for_labeling') return -1;
                if (a.status !== 'ready_for_labeling' && b.status === 'ready_for_labeling') return 1;
                return new Date(b.createdTime || b.timestamp) - new Date(a.createdTime || a.timestamp);
            });

            container.innerHTML = sortedData.map(item => {
                const statusClass = item.status === 'labeled' ? 'processed' : 'ready';
                const statusText = item.status === 'labeled' ? 'ì™„ë£Œ' : 'ëŒ€ê¸°';
                const statusIndicator = item.status === 'labeled' ? 'indicator-processed' : 'indicator-ready';
                
                return `
                    <div class="file-item ${statusClass} ${currentFile && currentFile.id === item.id ? 'selected' : ''}" 
                         onclick="selectFile(${item.id})">
                        <div class="file-info">
                            <div class="file-name">${item.fileName}</div>
                            <div class="file-meta">
                                <span class="status-indicator ${statusIndicator}"></span>
                                ${statusText} â€¢ 
                                ${formatFileSize(item.fileSize)} â€¢ 
                                ${formatDate(item.createdTime || item.timestamp)}
                                ${item.label ? `â€¢ ë¼ë²¨: ${item.label}` : ''}
                            </div>
                        </div>
                        <div class="file-status status-${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        // íŒŒì¼ ì„ íƒ
        async function selectFile(fileId) {
            const file = labelingData.find(item => item.id === fileId);
            if (!file) return;

            currentFile = file;
            displayFileList(); // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ í‘œì‹œ
            document.getElementById('audioPlayer').style.display = 'block';
            document.getElementById('labelingForm').style.display = 'block';
            document.getElementById('noFileSelected').style.display = 'none';

            // íŒŒì¼ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('currentFileName').textContent = file.fileName;
            
            // ì˜¤ë””ì˜¤ ì„¤ì •
            const audioElement = document.getElementById('audioElement');
            audioElement.src = `/api/audio/${encodeURIComponent(file.fileName)}`;
            
            // AI ì œì•ˆ ìš”ì²­
            await requestAISuggestion(file.fileName);
            
            // ê¸°ì¡´ ë¼ë²¨ ì •ë³´ í‘œì‹œ
            if (file.label) {
                selectLabel(file.label);
                document.getElementById('confidenceSlider').value = file.confidence || 50;
                updateConfidence(file.confidence || 50);
                document.getElementById('notesInput').value = file.notes || '';
            } else {
                // ì´ˆê¸°í™”
                document.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
                selectedLabel = null;
                document.getElementById('confidenceSlider').value = 50;
                updateConfidence(50);
                document.getElementById('notesInput').value = '';
            }
        }

        // AI ì œì•ˆ ìš”ì²­
        async function requestAISuggestion(fileName) {
            try {
                const response = await fetch('/api/labeling/ai-suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: fileName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    aiSuggestion = result.suggestion;
                    displayAISuggestion(aiSuggestion);
                } else {
                    console.error('AI ì œì•ˆ ìš”ì²­ ì‹¤íŒ¨:', result.message);
                }
            } catch (error) {
                console.error('AI ì œì•ˆ ìš”ì²­ ì˜¤ë¥˜:', error);
            }
        }

        // AI ì œì•ˆ í‘œì‹œ
        function displayAISuggestion(suggestion) {
            document.getElementById('aiSuggestion').style.display = 'block';
            
            // ì œì•ˆ ì •ë³´ í‘œì‹œ
            document.getElementById('suggestedLabel').textContent = suggestion.suggested_label;
            document.getElementById('suggestedConfidence').textContent = Math.round(suggestion.confidence * 100) + '%';
            document.getElementById('uncertainty').textContent = Math.round(suggestion.uncertainty * 100) + '%';
            document.getElementById('suggestionType').textContent = suggestion.suggestion_type;
            document.getElementById('reasoningText').textContent = suggestion.reasoning;
            
            // ì‹ ë¢°ë„ ë°” ì—…ë°ì´íŠ¸
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = (suggestion.confidence * 100) + '%';
            
            // ë¶ˆí™•ì‹¤ì„± í‘œì‹œê¸° ì—…ë°ì´íŠ¸
            const uncertaintyIndicator = document.getElementById('uncertaintyIndicator');
            if (suggestion.uncertainty < 0.3) {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-low';
                uncertaintyIndicator.textContent = 'ë‚®ìŒ';
            } else if (suggestion.uncertainty < 0.7) {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-medium';
                uncertaintyIndicator.textContent = 'ë³´í†µ';
            } else {
                uncertaintyIndicator.className = 'uncertainty-indicator uncertainty-high';
                uncertaintyIndicator.textContent = 'ë†’ìŒ';
            }
            
            // AI ì œì•ˆ ìˆ˜ë½ ë²„íŠ¼ í‘œì‹œ
            if (suggestion.requires_human_review) {
                document.getElementById('acceptAIBtn').style.display = 'none';
            } else {
                document.getElementById('acceptAIBtn').style.display = 'block';
            }
        }

        // AI ì œì•ˆ ìˆ˜ë½
        function acceptAISuggestion() {
            if (!aiSuggestion) return;
            
            // AI ì œì•ˆì„ ê¸°ë°˜ìœ¼ë¡œ ë¼ë²¨ ì„¤ì •
            const suggestedLabel = aiSuggestion.suggested_label;
            const suggestedConfidence = Math.round(aiSuggestion.confidence * 100);
            
            // ë¼ë²¨ ë§¤í•‘
            const labelMapping = {
                'normal_compressor': 'normal',
                'normal_fan': 'normal',
                'normal_motor': 'normal',
                'abnormal_bearing': 'critical',
                'abnormal_unbalance': 'warning',
                'abnormal_friction': 'warning',
                'abnormal_overload': 'critical'
            };
            
            const mappedLabel = labelMapping[suggestedLabel] || 'unknown';
            
            // ë¼ë²¨ ì„ íƒ
            selectLabel(mappedLabel);
            
            // ì‹ ë¢°ë„ ì„¤ì •
            document.getElementById('confidenceSlider').value = suggestedConfidence;
            updateConfidence(suggestedConfidence);
            
            // AI ì œì•ˆ ìˆ˜ë½ í‘œì‹œ
            const selectedBtn = document.querySelector(`[data-label="${mappedLabel}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('ai-suggested');
            }
            
            alert('AI ì œì•ˆì´ ìˆ˜ë½ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.');
        }

        // ë¼ë²¨ ì„ íƒ
        function selectLabel(label) {
            selectedLabel = label;
            document.querySelectorAll('.label-btn').forEach(btn => {
                btn.classList.remove('selected', 'ai-suggested');
                if (btn.dataset.label === label) {
                    btn.classList.add('selected');
                }
            });
        }

        // ì‹ ë¢°ë„ ì—…ë°ì´íŠ¸
        function updateConfidence(value) {
            document.getElementById('confidenceValue').textContent = value;
        }

        // ì˜¤ë””ì˜¤ ì¬ìƒ/ì¼ì‹œì •ì§€
        function togglePlay() {
            const audio = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                audio.pause();
                playBtn.textContent = 'â–¶ï¸ ì¬ìƒ';
                isPlaying = false;
            } else {
                audio.play();
                playBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                isPlaying = true;
            }
        }

        // ì˜¤ë””ì˜¤ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        document.getElementById('audioElement').addEventListener('timeupdate', function() {
            const audio = this;
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            const currentTime = formatTime(audio.currentTime);
            const duration = formatTime(audio.duration);
            document.getElementById('timeDisplay').textContent = `${currentTime} / ${duration}`;
        });

        // ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œ
        document.getElementById('audioElement').addEventListener('ended', function() {
            document.getElementById('playBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
            isPlaying = false;
        });

        // ì˜¤ë””ì˜¤ ì˜¤ë¥˜ ì²˜ë¦¬
        document.getElementById('audioElement').addEventListener('error', function(e) {
            console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
            document.getElementById('playBtn').textContent = 'âŒ ì¬ìƒ ë¶ˆê°€';
            document.getElementById('playBtn').disabled = true;
            alert('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        });

        // ì˜¤ë””ì˜¤ ë¡œë“œ ì™„ë£Œ ì‹œ
        document.getElementById('audioElement').addEventListener('loadeddata', function() {
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
        });

        // ë¼ë²¨ ì €ì¥
        async function saveLabel() {
            if (!currentFile || !selectedLabel) {
                alert('ë¼ë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const confidence = parseInt(document.getElementById('confidenceSlider').value);
            const notes = document.getElementById('notesInput').value;

            try {
                const response = await fetch('/api/labeling/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: currentFile.fileName,
                        label: selectedLabel,
                        confidence: confidence,
                        notes: notes,
                        labelerId: 'user_' + Date.now(),
                        aiSuggestion: aiSuggestion
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    const index = labelingData.findIndex(item => item.id === currentFile.id);
                    if (index >= 0) {
                        labelingData[index] = { ...labelingData[index], ...result.data };
                    }
                    
                    displayFileList();
                    loadStats();
                    loadAIPerformance();
                    
                    alert('ë¼ë²¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ë‹¤ìŒ íŒŒì¼ìœ¼ë¡œ ìë™ ì´ë™
                    const nextFile = labelingData.find(item => item.status === 'ready_for_labeling');
                    if (nextFile) {
                        selectFile(nextFile.id);
                    }
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íŒŒì¼ ê±´ë„ˆë›°ê¸°
        function skipFile() {
            if (currentFile) {
                const nextFile = labelingData.find(item => 
                    item.id !== currentFile.id && item.status === 'ready_for_labeling'
                );
                if (nextFile) {
                    selectFile(nextFile.id);
                } else {
                    alert('ë” ì´ìƒ ë¼ë²¨ë§í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR');
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
