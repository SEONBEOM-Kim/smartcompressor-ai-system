<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .sensor-selector {
            margin: 20px 0;
            text-align: center;
        }

        .sensor-selector select {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 25px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            outline: none;
        }

        .sensor-selector select:focus {
            border-color: #2980b9;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .data-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .data-controls select, .data-controls input {
            padding: 8px 15px;
            border: 2px solid #3498db;
            border-radius: 20px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            outline: none;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            text-align: center;
        }

        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .status-online { color: #27ae60; }
        .status-offline { color: #e74c3c; }
        .status-warning { color: #f39c12; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .compressor-analysis {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .on-off-ratio {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .ratio-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
        }

        .ratio-on {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .ratio-off {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .ratio-percentage {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ratio-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .ratio-summary {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .summary-item {
            text-align: center;
            margin: 5px;
        }

        .summary-label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            display: block;
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .pattern-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            margin: 5px;
        }

        .stat-label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 20px;
            }
            
            .controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ§Š ESP32 ì•„ì´ìŠ¤í¬ë¦¼ ê°€ê²Œ ëª¨ë‹ˆí„°ë§</h1>
            <p>ì‹¤ì‹œê°„ ì••ì¶•ê¸° ìƒíƒœ ë° ì„¼ì„œ ë°ì´í„° ë¶„ì„</p>
            
            <!-- ì„¼ì„œ ì„ íƒ -->
            <div class="sensor-selector">
                <label for="sensorSelect">ì„¼ì„œ ì„ íƒ:</label>
                <select id="sensorSelect" onchange="changeSensor()">
                    <option value="">ì „ì²´ ì„¼ì„œ</option>
                </select>
            </div>
            
            <!-- ë°ì´í„° ì œì–´ -->
            <div class="data-controls">
                <div>
                    <label for="dataLimit">ë°ì´í„° ê°œìˆ˜:</label>
                    <select id="dataLimit" onchange="loadData()">
                        <option value="50">50ê°œ</option>
                        <option value="100" selected>100ê°œ</option>
                        <option value="200">200ê°œ</option>
                    </select>
                </div>
                <div>
                    <label for="timeRange">ì‹œê°„ ë²”ìœ„:</label>
                    <select id="timeRange" onchange="loadData()">
                        <option value="6">ìµœê·¼ 6ì‹œê°„</option>
                        <option value="12">ìµœê·¼ 12ì‹œê°„</option>
                        <option value="24" selected>ìµœê·¼ 24ì‹œê°„</option>
                        <option value="72">ìµœê·¼ 3ì¼</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ìƒíƒœ ë°” -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="connectionStatus">ì—°ê²° ì¤‘...</div>
                <div class="status-label">ì—°ê²° ìƒíƒœ</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="deviceCount">0</div>
                <div class="status-label">í™œì„± ë””ë°”ì´ìŠ¤</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="lastUpdate">--:--</div>
                <div class="status-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="dataCount">0</div>
                <div class="status-label">ì´ ë°ì´í„° ìˆ˜</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="soundType">-</div>
                <div class="status-label">ì†Œë¦¬ ìœ í˜•</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="intensityLevel">-</div>
                <div class="status-label">ê°•ë„ ë ˆë²¨</div>
            </div>
        </div>

        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="alerts"></div>

        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success" onclick="startAutoRefresh()">â–¶ï¸ ìë™ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-warning" onclick="stopAutoRefresh()">â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€</button>
            <a href="/audio-research" class="btn btn-primary">ğŸµ ì˜¤ë””ì˜¤ ì—°êµ¬</a>
        </div>

        <!-- ë©”ì¸ ê·¸ë¦¬ë“œ -->
        <div class="grid">
            <!-- ì••ì¶•ê¸° ì‘ë™ íŒ¨í„´ ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ“Š ì••ì¶•ê¸° ì‘ë™ íŒ¨í„´ ë¶„ì„</h3>
                <div class="chart-container">
                    <canvas id="compressorChart"></canvas>
                </div>
                <div class="pattern-stats">
                    <div class="stat-item">
                        <span class="stat-label">í‰ê·  ì‘ë™ ì‹œê°„:</span>
                        <span class="stat-value" id="avgOnTime">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">í‰ê·  ëŒ€ê¸° ì‹œê°„:</span>
                        <span class="stat-value" id="avgOffTime">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì‘ë™ ì£¼ê¸°:</span>
                        <span class="stat-value" id="cycleCount">-</span>
                    </div>
                <div class="stat-item">
                    <span class="stat-label">ì‘ë™ íš¨ìœ¨ì„±:</span>
                    <span class="stat-value" id="efficiency">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">íŒ¨í„´ ì•ˆì •ì„±:</span>
                    <span class="stat-value" id="stability">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í˜„ì¬ ì˜¨ë„:</span>
                    <span class="stat-value" id="currentTemp">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì˜ˆìƒ ì‘ë™ë¹„ìœ¨:</span>
                    <span class="stat-value" id="expectedRatio">-</span>
                </div>
                    <div class="stat-item">
                        <span class="stat-label">íŒ¨í„´ íŠ¸ë Œë“œ:</span>
                        <span class="stat-value" id="patternTrend">-</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cyclePatternChart"></canvas>
                </div>
            </div>

            <!-- RMS ì—ë„ˆì§€ ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ”Š ì†ŒìŒ ë ˆë²¨ (RMS)</h3>
                <div class="chart-container">
                    <canvas id="rmsChart"></canvas>
                </div>
            </div>

            <!-- ì´ìƒ ì ìˆ˜ ì°¨íŠ¸ -->
            <div class="card">
                <h3>âš ï¸ ì´ìƒ ê°ì§€ ì ìˆ˜</h3>
                <div class="chart-container">
                    <canvas id="anomalyChart"></canvas>
                </div>
            </div>

            <!-- ë°ì‹œë²¨ ë ˆë²¨ ì°¨íŠ¸ -->
            <div class="card">
                <h3>ğŸ”Š ë°ì‹œë²¨ ë ˆë²¨</h3>
                <div class="chart-container">
                    <canvas id="decibelChart"></canvas>
                </div>
            </div>

            <!-- ì••ì¶•ê¸° ìƒíƒœ ë¶„ì„ -->
            <div class="compressor-analysis">
                <h3>ğŸ”§ ì••ì¶•ê¸° ìƒíƒœ ë¶„ì„ (45dB ê¸°ì¤€)</h3>
                <div class="on-off-ratio">
                    <div class="ratio-item ratio-on">
                        <div class="ratio-percentage" id="onPercentage">0%</div>
                        <div class="ratio-label">ON (â‰¥45dB)</div>
                    </div>
                    <div class="ratio-item ratio-off">
                        <div class="ratio-percentage" id="offPercentage">0%</div>
                        <div class="ratio-label">OFF (<45dB)</div>
                    </div>
                </div>
                <div class="ratio-summary">
                    <div class="summary-item">
                        <span class="summary-label">ì´ ì¸¡ì • íšŸìˆ˜:</span>
                        <span class="summary-value" id="totalMeasurements">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ON íšŸìˆ˜:</span>
                        <span class="summary-value" id="onCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">OFF íšŸìˆ˜:</span>
                        <span class="summary-value" id="offCount">0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="compressorStateChart"></canvas>
                </div>
            </div>

            <!-- ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ -->
            <div class="card">
                <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­</h3>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentRMS">0</div>
                        <div class="metric-label">RMS ì—ë„ˆì§€</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentDecibel">0</div>
                        <div class="metric-label">ë°ì‹œë²¨ (dB)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentCompressor">OFF</div>
                        <div class="metric-label">ì••ì¶•ê¸° ìƒíƒœ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentAnomaly">0.0</div>
                        <div class="metric-label">ì´ìƒ ì ìˆ˜</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentEfficiency">0.0</div>
                        <div class="metric-label">íš¨ìœ¨ì„±</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentSoundType">-</div>
                        <div class="metric-label">ì†Œë¦¬ ìœ í˜•</div>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ë°ì´í„° í…Œì´ë¸” -->
            <div class="card">
                <h3>ğŸ“‹ ìµœê·¼ ì„¼ì„œ ë°ì´í„°</h3>
                <div id="recentData">
                    <div class="loading">
                        <div class="spinner"></div>
                        ë°ì´í„° ë¡œë”© ì¤‘...
                    </div>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="footer">
            <p>Smart Compressor AI System - ESP32 ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</p>
            <p>ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸: <span id="updateTime">--:--:--</span></p>
        </div>
    </div>

    <script>
        // RMSë¥¼ ë°ì‹œë²¨ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function rmsToDecibel(rms) {
            if (rms <= 0) return 0;
            // 20 * log10(rms) ê³µì‹ ì‚¬ìš©
            return 20 * Math.log10(rms);
        }

        // ì „ì—­ ë³€ìˆ˜
        let charts = {};
        let autoRefreshInterval = null;
        let dataHistory = {
            timestamps: [],
            compressor: [],
            rms: [],
            anomaly: [],
            decibel: []
        };

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'ë°ì´í„° í¬ì¸íŠ¸'
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            };

            // ì••ì¶•ê¸° ìƒíƒœ ì°¨íŠ¸
            charts.compressor = new Chart(document.getElementById('compressorChart'), {
                type: 'line',
                data: {
                    labels: dataHistory.timestamps,
                    datasets: [{
                        label: 'ì••ì¶•ê¸° ìƒíƒœ',
                        data: dataHistory.compressor,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });

            // RMS ì°¨íŠ¸
            charts.rms = new Chart(document.getElementById('rmsChart'), {
                type: 'line',
                data: {
                    labels: dataHistory.timestamps,
                    datasets: [{
                        label: 'RMS ì—ë„ˆì§€',
                        data: dataHistory.rms,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });

            // ì´ìƒ ì ìˆ˜ ì°¨íŠ¸
            charts.anomaly = new Chart(document.getElementById('anomalyChart'), {
                type: 'line',
                data: {
                    labels: dataHistory.timestamps,
                    datasets: [{
                        label: 'ì´ìƒ ì ìˆ˜',
                        data: dataHistory.anomaly,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });

            // ë°ì‹œë²¨ ì°¨íŠ¸
            charts.decibel = new Chart(document.getElementById('decibelChart'), {
                type: 'line',
                data: {
                    labels: dataHistory.timestamps,
                    datasets: [{
                        label: 'ë°ì‹œë²¨ (dB)',
                        data: dataHistory.decibel,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.1
                    }]
                },
                options: chartOptions
            });
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            try {
                console.log('[DEBUG] refreshData ì‹œì‘');
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì¤‘...';
                document.getElementById('connectionStatus').className = 'status-value status-warning';

                console.log('[DEBUG] API í˜¸ì¶œ ì‹œì‘: /api/esp32/data/recent');
                
                const sensorId = document.getElementById('sensorSelect').value;
                const limit = document.getElementById('dataLimit').value;
                const hours = document.getElementById('timeRange').value;
                
                let url = `/api/esp32/data/recent?limit=${limit}&hours=${hours}`;
                if (sensorId) {
                    url += `&sensor_id=${encodeURIComponent(sensorId)}`;
                }
                
                console.log('[DEBUG] ìš”ì²­ URL:', url);
                
                // ìµœê·¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(url);
                console.log('[DEBUG] API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                const data = await response.json();
                console.log('[DEBUG] API ì‘ë‹µ ë°ì´í„°:', data);

                if (data.success) {
                    console.log('[DEBUG] ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œì‘, ë°ì´í„° ê°œìˆ˜:', data.data.length);
                    updateDashboard(data.data);
                    document.getElementById('connectionStatus').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('connectionStatus').className = 'status-value status-online';
                    console.log('[DEBUG] ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    throw new Error(data.message || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('[DEBUG] ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('connectionStatus').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('connectionStatus').className = 'status-value status-offline';
                showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'danger');
            }
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard(data) {
            if (!data || data.length === 0) {
                showAlert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            // ìµœì‹  ë°ì´í„°ë¡œ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
            const latest = data[0];
            const currentDecibel = rmsToDecibel(latest.rms_energy);
            document.getElementById('currentRMS').textContent = latest.rms_energy.toFixed(2);
            document.getElementById('currentDecibel').textContent = currentDecibel.toFixed(1) + ' dB';
            // 45dB ê¸°ì¤€ìœ¼ë¡œ ì••ì¶•ê¸° ìƒíƒœ ê²°ì •
            document.getElementById('currentCompressor').textContent = currentDecibel >= 45 ? 'ON' : 'OFF';
            document.getElementById('currentAnomaly').textContent = latest.anomaly_score.toFixed(3);
            document.getElementById('currentEfficiency').textContent = latest.efficiency_score.toFixed(3);
            
            // ìƒˆë¡œìš´ ê³ ê¸‰ íŠ¹ì§• ì—…ë°ì´íŠ¸
            const soundType = latest.sound_type || 0;
            const soundTypeNames = ['ì •ì ', 'ì••ì¶•ê¸°', 'íŒ¬', 'ì´ìƒìŒ', 'ê¸°íƒ€'];
            const soundTypeName = soundTypeNames[Math.round(soundType)] || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const soundTypeColors = ['#95a5a6', '#e74c3c', '#3498db', '#f39c12', '#9b59b6'];
            const soundTypeColor = soundTypeColors[Math.round(soundType)] || '#95a5a6';
            
            const soundTypeElement = document.getElementById('soundType');
            soundTypeElement.textContent = soundTypeName;
            soundTypeElement.style.color = soundTypeColor;
            
            const intensityLevel = (latest.intensity_level || 0) * 100;
            const intensityElement = document.getElementById('intensityLevel');
            intensityElement.textContent = intensityLevel.toFixed(1) + '%';
            
            // ê°•ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            if (intensityLevel > 70) {
                intensityElement.style.color = '#e74c3c'; // ë¹¨ê°„ìƒ‰
            } else if (intensityLevel > 40) {
                intensityElement.style.color = '#f39c12'; // ì£¼í™©ìƒ‰
            } else {
                intensityElement.style.color = '#27ae60'; // ì´ˆë¡ìƒ‰
            }

            // ìƒíƒœ ë°” ì—…ë°ì´íŠ¸
            document.getElementById('deviceCount').textContent = new Set(data.map(d => d.device_id)).size;
            document.getElementById('dataCount').textContent = data.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();

            // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
            updateCharts(data);
            updateRecentDataTable(data);

            // ì•Œë¦¼ ì²´í¬
            checkAlerts(latest);
        }

        // ì••ì¶•ê¸° ìƒíƒœ ë¶„ì„ (45dB ê¸°ì¤€)
        function updateCompressorAnalysis(data) {
            if (!data || data.length === 0) return;

            // ë°ì‹œë²¨ ê°’ ê³„ì‚°
            const decibelValues = data.map(d => rmsToDecibel(d.rms_energy));
            
            // ì••ì¶•ê¸° ìƒíƒœ ë¶„ë¥˜ (45dB ê¸°ì¤€)
            let onCount = 0;
            let offCount = 0;
            const compressorStates = [];

            decibelValues.forEach((db, index) => {
                let state;
                if (db >= 45) {
                    state = 1; // ON (45dB ì´ìƒ)
                    onCount++;
                } else {
                    state = 0; // OFF (45dB ë¯¸ë§Œ)
                    offCount++;
                }
                compressorStates.push(state);
            });

            // ë¹„ìœ¨ ê³„ì‚°
            const total = data.length;
            const onPercentage = total > 0 ? Math.round((onCount / total) * 100) : 0;
            const offPercentage = total > 0 ? Math.round((offCount / total) * 100) : 0;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('onPercentage').textContent = onPercentage + '%';
            document.getElementById('offPercentage').textContent = offPercentage + '%';
            document.getElementById('totalMeasurements').textContent = total;
            document.getElementById('onCount').textContent = onCount;
            document.getElementById('offCount').textContent = offCount;

            // ì••ì¶•ê¸° ìƒíƒœ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateCompressorStateChart(data, compressorStates);
        }

        // ì••ì¶•ê¸° ìƒíƒœ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCompressorStateChart(data, states) {
            if (!charts.compressorState) {
                const ctx = document.getElementById('compressorStateChart').getContext('2d');
                charts.compressorState = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ì••ì¶•ê¸° ìƒíƒœ',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }, {
                            label: 'ë°ì‹œë²¨ ë ˆë²¨',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 0,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        if (value === 1) return 'ON';
                                        if (value === 0) return 'OFF';
                                        return 'ì¤‘ê°„';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' dB';
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        if (context.datasetIndex === 0) {
                                            const db = rmsToDecibel(data[context.dataIndex].rms_energy);
                                            return `ë°ì‹œë²¨: ${db.toFixed(1)} dB`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // ìµœê·¼ 50ê°œ ë°ì´í„°ë§Œ í‘œì‹œ
            const limit = Math.min(50, data.length);
            const labels = Array.from({length: limit}, (_, i) => i + 1);
            const decibelValues = data.slice(0, limit).map(d => rmsToDecibel(d.rms_energy));

            charts.compressorState.data.labels = labels;
            charts.compressorState.data.datasets[0].data = states.slice(0, limit);
            charts.compressorState.data.datasets[1].data = decibelValues;
            charts.compressorState.update();
        }

        // ì••ì¶•ê¸° ì‘ë™ íŒ¨í„´ ë¶„ì„ (ì‚¬ì´í´ë³„ ì´ìƒ ê°ì§€)
        function analyzeCompressorPattern(data) {
            if (!data || data.length === 0) return;

            // 45dB ê¸°ì¤€ìœ¼ë¡œ ì••ì¶•ê¸° ìƒíƒœ ê³„ì‚°
            const compressorStates = data.map(d => rmsToDecibel(d.rms_energy) >= 45 ? 1 : 0);

            // ì‚¬ì´í´ë³„ ë¶„ì„
            let cycles = [];
            let currentCycle = { onTime: 0, offTime: 0, totalTime: 0, onRatio: 0 };
            let isOn = false;
            let cycleCount = 0;

            for (let i = 0; i < compressorStates.length; i++) {
                const isCurrentlyOn = compressorStates[i] === 1;

                if (isCurrentlyOn && !isOn) {
                    // OFF -> ON ì „í™˜ (ìƒˆ ì‚¬ì´í´ ì‹œì‘)
                    if (currentCycle.totalTime > 0) {
                        currentCycle.onRatio = currentCycle.onTime / currentCycle.totalTime;
                        cycles.push({...currentCycle});
                    }
                    currentCycle = { onTime: 0, offTime: 0, totalTime: 0, onRatio: 0 };
                    isOn = true;
                    cycleCount++;
                } else if (!isCurrentlyOn && isOn) {
                    // ON -> OFF ì „í™˜
                    isOn = false;
                }

                if (isOn) {
                    currentCycle.onTime++;
                } else {
                    currentCycle.offTime++;
                }
                currentCycle.totalTime++;
            }

            // ë§ˆì§€ë§‰ ì‚¬ì´í´ ì²˜ë¦¬
            if (currentCycle.totalTime > 0) {
                currentCycle.onRatio = currentCycle.onTime / currentCycle.totalTime;
                cycles.push(currentCycle);
            }

            // ì´ìƒ ê°ì§€ ë¶„ì„
            const anomalyAnalysis = detectPatternAnomalies(cycles);
            
            // í†µê³„ ê³„ì‚°
            const avgOnTime = cycles.length > 0 ? Math.round(cycles.reduce((sum, cycle) => sum + cycle.onTime, 0) / cycles.length) : 0;
            const avgOffTime = cycles.length > 0 ? Math.round(cycles.reduce((sum, cycle) => sum + cycle.offTime, 0) / cycles.length) : 0;
            const avgOnRatio = cycles.length > 0 ? (cycles.reduce((sum, cycle) => sum + cycle.onRatio, 0) / cycles.length * 100) : 0;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('avgOnTime').textContent = avgOnTime > 0 ? `${avgOnTime}ë¶„` : '-';
            document.getElementById('avgOffTime').textContent = avgOffTime > 0 ? `${avgOffTime}ë¶„` : '-';
            document.getElementById('cycleCount').textContent = cycleCount > 0 ? `${cycleCount}íšŒ` : '-';

            // ì´ìƒ ê°ì§€ ì ìˆ˜ ì—…ë°ì´íŠ¸
            updateAnomalyScore(anomalyAnalysis.anomalyScore);
            
            // íš¨ìœ¨ì„± ë° ì•ˆì •ì„± ê³„ì‚°
            const efficiency = typeof avgOnRatio === 'number' && avgOnRatio > 0 ? avgOnRatio : 0;
            const stability = typeof anomalyAnalysis.anomalyScore === 'number' ? (100 - anomalyAnalysis.anomalyScore) : 100;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('efficiency').textContent = efficiency > 0 ? `${Number(efficiency).toFixed(1)}%` : '-';
            document.getElementById('stability').textContent = stability > 0 ? `${Number(stability).toFixed(0)}%` : '-';
            
            // ì˜¨ë„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (anomalyAnalysis.weatherData) {
                document.getElementById('currentTemp').textContent = `${anomalyAnalysis.weatherData.temperature}Â°C`;
                if (anomalyAnalysis.normalRange) {
                    document.getElementById('expectedRatio').textContent = `${(anomalyAnalysis.normalRange.predicted * 100).toFixed(1)}%`;
                }
            } else {
                document.getElementById('currentTemp').textContent = 'ë°ì´í„° ì—†ìŒ';
                document.getElementById('expectedRatio').textContent = '-';
            }
            
            // íŠ¸ë Œë“œ í‘œì‹œ
            const trendElement = document.getElementById('patternTrend');
            if (trendElement) {
                const trendText = {
                    'increasing': 'ğŸ“ˆ ì¦ê°€',
                    'decreasing': 'ğŸ“‰ ê°ì†Œ', 
                    'stable': 'â¡ï¸ ì•ˆì •',
                    'insufficient_data': 'â“ ë°ì´í„° ë¶€ì¡±'
                };
                trendElement.textContent = trendText[anomalyAnalysis.trend] || 'â“';
                
                // íŠ¸ë Œë“œì— ë”°ë¥¸ ìƒ‰ìƒ
                if (anomalyAnalysis.trend === 'increasing') {
                    trendElement.style.color = '#e74c3c';
                } else if (anomalyAnalysis.trend === 'decreasing') {
                    trendElement.style.color = '#3498db';
                } else {
                    trendElement.style.color = '#27ae60';
                }
            }
            
            // ê°œì„ ëœ ì‚¬ì´í´ íŒ¨í„´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateImprovedCycleChart(cycles, anomalyAnalysis);

            return {
                cycles,
                cycleCount,
                avgOnTime,
                avgOffTime,
                avgOnRatio,
                anomalyAnalysis
            };
        }

        // ì˜¨ë„ ê¸°ë°˜ ì§€ëŠ¥í˜• ì´ìƒ ê°ì§€ ì‹œìŠ¤í…œ
        let weatherData = null;
        let lastWeatherUpdate = 0;
        const WEATHER_UPDATE_INTERVAL = 30 * 60 * 1000; // 30ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸

        // ê¸°ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„œë²„ API ì‚¬ìš©)
        async function fetchWeatherData() {
            const now = Date.now();
            if (now - lastWeatherUpdate < WEATHER_UPDATE_INTERVAL && weatherData) {
                return weatherData;
            }

            try {
                // ì„œë²„ì˜ ê¸°ìƒ API ì‚¬ìš© (ì„œë²„ì—ì„œ ìºì‹±ë¨)
                const response = await fetch('/api/weather/current');
                const data = await response.json();
                
                if (data.success) {
                    weatherData = {
                        temperature: data.temperature,
                        humidity: data.humidity,
                        timestamp: now,
                        location: data.location
                    };
                    lastWeatherUpdate = now;
                    
                    console.log('ğŸŒ¡ï¸ ê¸°ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸:', weatherData);
                    return weatherData;
                } else {
                    console.error('ê¸°ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', data.message);
                    return null;
                }
            } catch (error) {
                console.error('ê¸°ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ì˜¨ë„ ê¸°ë°˜ ì •ìƒ ì‘ë™ ë²”ìœ„ ì˜ˆì¸¡
        function predictNormalOperationRange(temperature, timeOfDay) {
            // ê¸°ë³¸ ì‘ë™ ë¹„ìœ¨ (ì˜¨ë„ 20ë„ ê¸°ì¤€)
            const baseOperationRatio = 0.5;
            
            // ì˜¨ë„ ê³„ìˆ˜ (ì˜¨ë„ê°€ ë‚®ì„ìˆ˜ë¡ ì‘ë™ ì‹œê°„ ì¦ê°€)
            const tempCoefficient = Math.max(0.3, 1 - (temperature - 20) * 0.02);
            
            // ì‹œê°„ëŒ€ ê³„ìˆ˜ (ë°¤ì‹œê°„ ì‘ë™ ê°ì†Œ)
            const timeCoefficient = timeOfDay >= 22 || timeOfDay <= 6 ? 0.7 : 1.0;
            
            // ì˜ˆì¸¡ëœ ì •ìƒ ì‘ë™ ë¹„ìœ¨
            const predictedRatio = baseOperationRatio * tempCoefficient * timeCoefficient;
            
            // í—ˆìš© ì˜¤ì°¨ ë²”ìœ„ (Â±20%)
            const tolerance = 0.2;
            
            return {
                min: Math.max(0, predictedRatio - tolerance),
                max: Math.min(1, predictedRatio + tolerance),
                predicted: predictedRatio,
                temperature: temperature,
                timeOfDay: timeOfDay
            };
        }

        // íŒ¨í„´ ì´ìƒ ê°ì§€ ì•Œê³ ë¦¬ì¦˜ (ì˜¨ë„ ê¸°ë°˜)
        async function detectPatternAnomalies(cycles) {
            if (cycles.length < 3) {
                return { anomalyScore: 0, anomalies: [], trend: 'insufficient_data' };
            }

            // 1. ê¸°ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const weather = await fetchWeatherData();
            const currentTime = new Date();
            const timeOfDay = currentTime.getHours();
            
            const recentCycles = cycles.slice(-5); // ìµœê·¼ 5ê°œ ì‚¬ì´í´
            const onTimes = recentCycles.map(cycle => cycle.onTime);
            const onRatios = recentCycles.map(cycle => cycle.onRatio);
            
            // 2. ì˜¨ë„ ê¸°ë°˜ ì •ìƒ ë²”ìœ„ ì˜ˆì¸¡
            let normalRange = null;
            if (weather) {
                normalRange = predictNormalOperationRange(weather.temperature, timeOfDay);
            }
            
            // 3. ê¸°ë³¸ í†µê³„ ê³„ì‚°
            const avgOnTime = onTimes.reduce((sum, time) => sum + time, 0) / onTimes.length;
            const avgOnRatio = onRatios.reduce((sum, ratio) => sum + ratio, 0) / onRatios.length;
            const currentOnRatio = onRatios[onRatios.length - 1];
            
            let anomalyScore = 0;
            const anomalies = [];
            
            // 4. ì˜¨ë„ ê¸°ë°˜ ì´ìƒ ê°ì§€
            if (normalRange) {
                const isWithinNormalRange = currentOnRatio >= normalRange.min && currentOnRatio <= normalRange.max;
                
                if (!isWithinNormalRange) {
                    const deviation = Math.abs(currentOnRatio - normalRange.predicted);
                    const severity = Math.min(deviation / 0.2, 1); // 20% ì´ìƒ ë²—ì–´ë‚˜ë©´ ìµœëŒ€ ì ìˆ˜
                    anomalyScore = Math.max(anomalyScore, severity);
                    
                    if (currentOnRatio > normalRange.max) {
                        anomalies.push(`ì˜¨ë„ ëŒ€ë¹„ ê³¼ë¶€í•˜: ${(currentOnRatio * 100).toFixed(1)}% (ì˜ˆìƒ: ${(normalRange.predicted * 100).toFixed(1)}%, ì˜¨ë„: ${weather.temperature}Â°C)`);
                    } else {
                        anomalies.push(`ì˜¨ë„ ëŒ€ë¹„ ì €ë¶€í•˜: ${(currentOnRatio * 100).toFixed(1)}% (ì˜ˆìƒ: ${(normalRange.predicted * 100).toFixed(1)}%, ì˜¨ë„: ${weather.temperature}Â°C)`);
                    }
                } else {
                    anomalies.push(`ì •ìƒ ì‘ë™ ë²”ìœ„ ë‚´ (ì˜¨ë„: ${weather.temperature}Â°C, ì˜ˆìƒ: ${(normalRange.predicted * 100).toFixed(1)}%)`);
                }
            } else {
                // 5. ê¸°ìƒ ë°ì´í„° ì—†ì„ ë•Œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
                const timeVariance = onTimes.reduce((sum, time) => sum + Math.pow(time - avgOnTime, 2), 0) / onTimes.length;
                const ratioVariance = onRatios.reduce((sum, ratio) => sum + Math.pow(ratio - avgOnRatio, 2), 0) / onRatios.length;
                const timeStdDev = Math.sqrt(timeVariance);
                const ratioStdDev = Math.sqrt(ratioVariance);
                
                if (timeStdDev > 0) {
                    const timeZScore = Math.abs(onTimes[onTimes.length - 1] - avgOnTime) / timeStdDev;
                    anomalyScore = Math.max(anomalyScore, Math.min(timeZScore / 2, 1));
                }
                
                if (ratioStdDev > 0) {
                    const ratioZScore = Math.abs(currentOnRatio - avgOnRatio) / ratioStdDev;
                    anomalyScore = Math.max(anomalyScore, Math.min(ratioZScore / 2, 1));
                }
            }
            
            // 6. íŠ¸ë Œë“œ ë¶„ì„
            let trend = 'stable';
            if (onTimes.length >= 3) {
                const recentTrend = onTimes.slice(-3);
                const isIncreasing = recentTrend[2] > recentTrend[1] && recentTrend[1] > recentTrend[0];
                const isDecreasing = recentTrend[2] < recentTrend[1] && recentTrend[1] < recentTrend[0];
                
                if (isIncreasing) trend = 'increasing';
                else if (isDecreasing) trend = 'decreasing';
            }
            
            // 7. ì¢…í•© ì´ìƒ ì ìˆ˜ (0-100ì )
            const finalScore = Math.round(anomalyScore * 100);
            
            return {
                anomalyScore: finalScore,
                anomalies,
                trend,
                avgOnRatio: avgOnRatio * 100,
                currentOnRatio: currentOnRatio * 100,
                avgOnTime: avgOnTime,
                currentOnTime: onTimes[onTimes.length - 1],
                weatherData: weather,
                normalRange: normalRange
            };
        }

        // ì´ìƒ ê°ì§€ ì ìˆ˜ ì—…ë°ì´íŠ¸ (0-100ì )
        function updateAnomalyScore(score) {
            const anomalyElement = document.getElementById('currentAnomaly');
            if (anomalyElement) {
                anomalyElement.textContent = `${score}ì `;
                
                // ìƒ‰ìƒ ë³€ê²½ (0-100ì  ê¸°ì¤€)
                if (score >= 70) {
                    anomalyElement.style.color = '#e74c3c'; // ë¹¨ê°„ìƒ‰ - ìœ„í—˜
                } else if (score >= 40) {
                    anomalyElement.style.color = '#f39c12'; // ì£¼í™©ìƒ‰ - ì£¼ì˜
                } else if (score >= 20) {
                    anomalyElement.style.color = '#f1c40f'; // ë…¸ë€ìƒ‰ - ê²½ê³ 
                } else {
                    anomalyElement.style.color = '#27ae60'; // ì´ˆë¡ìƒ‰ - ì •ìƒ
                }
            }
        }

        // í†µí•©ëœ ì‘ë™ íŒ¨í„´ íë¦„ ì°¨íŠ¸
        function updateImprovedCycleChart(cycles, anomalyAnalysis) {
            if (!charts.cyclePattern) {
                const ctx = document.getElementById('cyclePatternChart').getContext('2d');
                charts.cyclePattern = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ì‘ë™ íŒ¨í„´ íë¦„',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }, {
                            label: 'í‰ê·  ì‘ë™ ì‹œê°„',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }, {
                            label: 'ì´ìƒ ì„ê³„ê°’',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            fill: false,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ì‘ë™ ì‹œê°„ (ë¶„)'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ì‹œê°„ íë¦„'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const dataIndex = context.dataIndex;
                                        if (dataIndex < cycles.length) {
                                            const cycle = cycles[dataIndex];
                                            const onRatio = (cycle.onRatio * 100).toFixed(1);
                                            return [
                                                `ì‘ë™ ë¹„ìœ¨: ${onRatio}%`,
                                                `ì´ ì‹œê°„: ${cycle.totalTime}ë¶„`,
                                                `íš¨ìœ¨ì„±: ${cycle.onRatio > 0.5 ? 'ë†’ìŒ' : 'ë‚®ìŒ'}`
                                            ];
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // ëª¨ë“  ì‚¬ì´í´ì„ ì‹œê°„ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
            const labels = cycles.map((_, index) => `C${index + 1}`);
            const onTimes = cycles.map(cycle => cycle.onTime);
            
            // í‰ê·  ì‘ë™ ì‹œê°„ ê³„ì‚°
            const avgOnTime = onTimes.length > 0 ? onTimes.reduce((sum, time) => sum + time, 0) / onTimes.length : 0;
            const avgLine = new Array(onTimes.length).fill(avgOnTime);
            
            // ì´ìƒ ì„ê³„ê°’ (í‰ê·  Â± 1.5Ïƒ)
            const variance = onTimes.reduce((sum, time) => sum + Math.pow(time - avgOnTime, 2), 0) / onTimes.length;
            const stdDev = Math.sqrt(variance);
            const threshold = new Array(onTimes.length).fill(avgOnTime + 1.5 * stdDev);

            charts.cyclePattern.data.labels = labels;
            charts.cyclePattern.data.datasets[0].data = onTimes;
            charts.cyclePattern.data.datasets[1].data = avgLine;
            charts.cyclePattern.data.datasets[2].data = threshold;
            charts.cyclePattern.update();
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts(data) {
            // 45dB ê¸°ì¤€ìœ¼ë¡œ ì••ì¶•ê¸° ìƒíƒœ ê³„ì‚°
            const compressor = data.map(d => rmsToDecibel(d.rms_energy) >= 45 ? 1 : 0);
            const rms = data.map(d => d.rms_energy);
            const anomaly = data.map(d => d.anomaly_score);
            const decibel = data.map(d => rmsToDecibel(d.rms_energy));

            // ìµœê·¼ 50ê°œ ë°ì´í„°ë§Œ í‘œì‹œ
            const limit = Math.min(50, data.length);
            const recentData = {
                labels: Array.from({length: limit}, (_, i) => i + 1), // ì¸ë±ìŠ¤ ê¸°ë°˜ ë¼ë²¨
                compressor: compressor.slice(0, limit),
                rms: rms.slice(0, limit),
                anomaly: anomaly.slice(0, limit),
                decibel: decibel.slice(0, limit)
            };

            // ì••ì¶•ê¸° ìƒíƒœ ë¶„ì„ (ë°ì‹œë²¨ ê¸°ë°˜)
            updateCompressorAnalysis(data);

            // ì••ì¶•ê¸° ì‘ë™ íŒ¨í„´ ë¶„ì„
            analyzeCompressorPattern(data);

            // ê° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (charts.compressor) {
                charts.compressor.data.labels = recentData.labels;
                charts.compressor.data.datasets[0].data = recentData.compressor;
                charts.compressor.update();
            }

            if (charts.rms) {
                charts.rms.data.labels = recentData.labels;
                charts.rms.data.datasets[0].data = recentData.rms;
                charts.rms.update();
            }

            if (charts.anomaly) {
                charts.anomaly.data.labels = recentData.labels;
                charts.anomaly.data.datasets[0].data = recentData.anomaly;
                charts.anomaly.update();
            }

            if (charts.decibel) {
                charts.decibel.data.labels = recentData.labels;
                charts.decibel.data.datasets[0].data = recentData.decibel;
                charts.decibel.update();
            }
        }

        // ìµœê·¼ ë°ì´í„° í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateRecentDataTable(data) {
            const soundTypeNames = ['ì •ì ', 'ì••ì¶•ê¸°', 'íŒ¬', 'ì´ìƒìŒ', 'ê¸°íƒ€'];
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ì‹œê°„</th>
                            <th>ë””ë°”ì´ìŠ¤</th>
                            <th>RMS</th>
                            <th>ë°ì‹œë²¨</th>
                            <th>ì••ì¶•ê¸°</th>
                            <th>ì´ìƒì ìˆ˜</th>
                            <th>íš¨ìœ¨ì„±</th>
                            <th>ì†Œë¦¬ìœ í˜•</th>
                            <th>ê°•ë„</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.slice(0, 10).map(item => {
                            const soundType = item.sound_type || 0;
                            const soundTypeName = soundTypeNames[Math.round(soundType)] || 'ì•Œ ìˆ˜ ì—†ìŒ';
                            const intensity = ((item.intensity_level || 0) * 100).toFixed(1);
                            
                            return `
                                <tr>
                                    <td>${new Date(item.received_at).toLocaleTimeString()}</td>
                                    <td>${item.device_id}</td>
                                    <td>${item.rms_energy.toFixed(2)}</td>
                                    <td>${rmsToDecibel(item.rms_energy).toFixed(1)} dB</td>
                                    <td>${rmsToDecibel(item.rms_energy) >= 45 ? 'ON' : 'OFF'}</td>
                                    <td>${item.anomaly_score.toFixed(3)}</td>
                                    <td>${item.efficiency_score.toFixed(3)}</td>
                                    <td>${soundTypeName}</td>
                                    <td>${intensity}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('recentData').innerHTML = table;
        }

        // ì•Œë¦¼ ì²´í¬
        function checkAlerts(data) {
            const alerts = [];

            if (data.anomaly_score > 0.7) {
                alerts.push({
                    type: 'danger',
                    message: `ë†’ì€ ì´ìƒ ì ìˆ˜ ê°ì§€: ${data.anomaly_score.toFixed(3)}`
                });
            }

            if (data.rms_energy > 5000) {
                alerts.push({
                    type: 'warning',
                    message: `ë†’ì€ ì†ŒìŒ ë ˆë²¨: ${data.rms_energy.toFixed(2)}`
                });
            }

            if (data.efficiency_score < 0.3) {
                alerts.push({
                    type: 'warning',
                    message: `ë‚®ì€ íš¨ìœ¨ì„±: ${data.efficiency_score.toFixed(3)}`
                });
            }

            if (rmsToDecibel(data.rms_energy) > 80) {
                alerts.push({
                    type: 'warning',
                    message: `ë†’ì€ ë°ì‹œë²¨ ë ˆë²¨: ${rmsToDecibel(data.rms_energy).toFixed(1)} dB`
                });
            }

            if (alerts.length === 0) {
                alerts.push({
                    type: 'success',
                    message: 'ëª¨ë“  ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ ì¤‘'
                });
            }

            displayAlerts(alerts);
        }

        // ì•Œë¦¼ í‘œì‹œ
        function displayAlerts(alerts) {
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.innerHTML = alerts.map(alert => 
                `<div class="alert alert-${alert.type}">${alert.message}</div>`
            ).join('');
        }

        // ì•Œë¦¼ í‘œì‹œ (ì¼ë°˜)
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            alertsContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                alertsContainer.innerHTML = '';
            }, 5000);
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(refreshData, 5000); // 5ì´ˆë§ˆë‹¤
            showAlert('ìë™ ìƒˆë¡œê³ ì¹¨ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showAlert('ìë™ ìƒˆë¡œê³ ì¹¨ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        // ì„¼ì„œ ëª©ë¡ ë¡œë“œ
        async function loadSensorList() {
            try {
                const response = await fetch('/api/esp32/data/recent?limit=1');
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const sensors = [...new Set(data.data.map(item => item.device_id))];
                    const sensorSelect = document.getElementById('sensorSelect');
                    
                    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì „ì²´ ì„¼ì„œ ì œì™¸)
                    while (sensorSelect.children.length > 1) {
                        sensorSelect.removeChild(sensorSelect.lastChild);
                    }
                    
                    // ì„¼ì„œ ì˜µì…˜ ì¶”ê°€
                    sensors.forEach(sensor => {
                        const option = document.createElement('option');
                        option.value = sensor;
                        option.textContent = sensor;
                        sensorSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ì„¼ì„œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì„¼ì„œ ë³€ê²½
        function changeSensor() {
            loadData();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadSensorList();
            refreshData();
            startAutoRefresh();
        });
    </script>
</body>
</html>
