<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 센서 모니터링 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="/static/css/esp32_dashboard.css">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🧊 ESP32 아이스크림 가게 모니터링</h1>
            <p>실시간 압축기 상태 및 센서 데이터 분석</p>
            
            <!-- 센서 선택 -->
            <div class="sensor-selector">
                <label for="sensorSelect">센서 선택:</label>
                <select id="sensorSelect" onchange="changeSensor()">
                    <option value="">전체 센서</option>
                </select>
            </div>
            
            <!-- 데이터 제어 -->
            <div class="data-controls">
                <div>
                    <label for="dataLimit">데이터 개수:</label>
                    <select id="dataLimit" onchange="loadData()">
                        <option value="50">50개</option>
                        <option value="100" selected>100개</option>
                        <option value="200">200개</option>
                    </select>
                </div>
                <div>
                    <label for="timeRange">시간 범위:</label>
                    <select id="timeRange" onchange="loadData()">
                        <option value="6">최근 6시간</option>
                        <option value="12">최근 12시간</option>
                        <option value="24" selected>최근 24시간</option>
                        <option value="72">최근 3일</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 상태 바 -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="connectionStatus">연결 중...</div>
                <div class="status-label">연결 상태</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="deviceCount">0</div>
                <div class="status-label">활성 디바이스</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="lastUpdate">--:--</div>
                <div class="status-label">마지막 업데이트</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="dataCount">0</div>
                <div class="status-label">총 데이터 수</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="soundType">-</div>
                <div class="status-label">소리 유형</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="intensityLevel">-</div>
                <div class="status-label">강도 레벨</div>
            </div>
        </div>

        <!-- 알림 영역 -->
        <div id="alerts"></div>

        <!-- 컨트롤 -->
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">🔄 새로고침</button>
            <button class="btn btn-success" onclick="startAutoRefresh()">▶️ 자동 새로고침</button>
            <button class="btn btn-warning" onclick="stopAutoRefresh()">⏸️ 자동 새로고침 중지</button>
            <a href="/audio-research" class="btn btn-primary">🎵 오디오 연구</a>
        </div>

        <!-- 메인 그리드 -->
        <div class="grid">
            <!-- 압축기 작동 패턴 차트 -->
            <div class="card">
                <h3>📊 압축기 작동 패턴 분석</h3>
                <div class="chart-container">
                    <canvas id="compressorChart"></canvas>
                </div>
                <div class="pattern-stats">
                    <div class="stat-item">
                        <span class="stat-label">평균 작동 시간:</span>
                        <span class="stat-value" id="avgOnTime">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">평균 대기 시간:</span>
                        <span class="stat-value" id="avgOffTime">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">작동 주기:</span>
                        <span class="stat-value" id="cycleCount">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">작동 효율성:</span>
                        <span class="stat-value" id="efficiency">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">패턴 안정성:</span>
                        <span class="stat-value" id="stability">-</span>
                    </div>
                </div>
            </div>

            <!-- RMS 에너지 차트 -->
            <div class="card">
                <h3>🔊 소음 레벨 (RMS)</h3>
                <div class="chart-container">
                    <canvas id="rmsChart"></canvas>
                </div>
            </div>

            <!-- 이상 점수 차트 -->
            <div class="card">
                <h3>⚠️ 이상 감지 점수</h3>
                <div class="chart-container">
                    <canvas id="anomalyChart"></canvas>
                </div>
            </div>

            <!-- 데시벨 레벨 차트 -->
            <div class="card">
                <h3>🔊 데시벨 레벨</h3>
                <div class="chart-container">
                    <canvas id="decibelChart"></canvas>
                </div>
            </div>

            <!-- 압축기 상태 분석 -->
            <div class="compressor-analysis">
                <h3>🔧 압축기 상태 분석 (45dB 기준)</h3>
                <div class="on-off-ratio">
                    <div class="ratio-item ratio-on">
                        <div class="ratio-percentage" id="onPercentage">0%</div>
                        <div class="ratio-label">ON (≥45dB)</div>
                    </div>
                    <div class="ratio-item ratio-off">
                        <div class="ratio-percentage" id="offPercentage">0%</div>
                        <div class="ratio-label">OFF (<45dB)</div>
                    </div>
                </div>
                <div class="ratio-summary">
                    <div class="summary-item">
                        <span class="summary-label">총 측정 횟수:</span>
                        <span class="summary-value" id="totalMeasurements">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ON 횟수:</span>
                        <span class="summary-value" id="onCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">OFF 횟수:</span>
                        <span class="summary-value" id="offCount">0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="compressorStateChart"></canvas>
                </div>
            </div>

            <!-- 실시간 메트릭 -->
            <div class="card">
                <h3>📈 실시간 메트릭</h3>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentRMS">0</div>
                        <div class="metric-label">RMS 에너지</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentDecibel">0</div>
                        <div class="metric-label">데시벨 (dB)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentCompressor">OFF</div>
                        <div class="metric-label">압축기 상태</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentAnomaly">0.0</div>
                        <div class="metric-label">이상 점수</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentEfficiency">0.0</div>
                        <div class="metric-label">효율성</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="currentSoundType">-</div>
                        <div class="metric-label">소리 유형</div>
                    </div>
                </div>
            </div>

            <!-- 최근 데이터 테이블 -->
            <div class="card">
                <h3>📋 최근 센서 데이터</h3>
                <div id="recentData">
                    <div class="loading">
                        <div class="spinner"></div>
                        데이터 로딩 중...
                    </div>
                </div>
            </div>
        </div>

        <!-- 푸터 -->
        <div class="footer">
            <p>Smart Compressor AI System - ESP32 센서 모니터링 대시보드</p>
            <p>실시간 데이터 업데이트: <span id="updateTime">--:--:--</span></p>
        </div>
    </div>

    <!-- JavaScript 모듈들 -->
    <script src="/static/js/esp32_utils.js"></script>
    <script src="/static/js/esp32_api.js"></script>
    <script src="/static/js/esp32_charts.js"></script>
    <script src="/static/js/esp32_dashboard.js"></script>
</body>
</html>
