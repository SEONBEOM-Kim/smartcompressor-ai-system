<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 라벨링 관리 대시보드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            border-left: 5px solid #FF6B6B;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #FF6B6B;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .chart-section {
            margin: 40px 0;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .chart-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #FF6B6B;
            border-bottom-color: #FF6B6B;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-normal {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .badge-critical {
            background: #ffebee;
            color: #c62828;
        }

        .badge-unknown {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .expert-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            border-left: 5px solid #FF6B6B;
        }

        .expert-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .expert-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .expert-stat {
            text-align: center;
        }

        .expert-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF6B6B;
        }

        .expert-stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        .quality-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .quality-excellent { background: #4caf50; }
        .quality-good { background: #8bc34a; }
        .quality-fair { background: #ffc107; }
        .quality-poor { background: #f44336; }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6B6B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> 라벨링 관리 대시보드</h1>
            <p>전문가 라벨링 현황을 모니터링하고 품질을 관리하세요</p>
        </div>

        <div class="content">
            <!-- 로딩 섹션 -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>라벨링 데이터를 로딩 중입니다...</p>
            </div>

            <!-- 메인 대시보드 -->
            <div id="mainDashboard" class="hidden">
                <!-- 통계 카드 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-tags"></i> 총 라벨링 수</h3>
                        <div class="stat-value" id="totalLabeled">-</div>
                        <div class="stat-label">누적 라벨링</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3><i class="fas fa-calendar-day"></i> 오늘 라벨링</h3>
                        <div class="stat-value" id="todayLabeled">-</div>
                        <div class="stat-label">오늘 완료</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3><i class="fas fa-bullseye"></i> 라벨링 정확도</h3>
                        <div class="stat-value" id="accuracy">-</div>
                        <div class="stat-label">평균 정확도</div>
                    </div>
                    
                    <div class="stat-card">
                        <h3><i class="fas fa-clock"></i> 대기 중인 파일</h3>
                        <div class="stat-value" id="pendingCount">-</div>
                        <div class="stat-label">라벨링 대기</div>
                    </div>
                </div>

                <!-- 탭 섹션 -->
                <div class="tabs">
                    <button class="tab active" onclick="showTab('overview')">📊 개요</button>
                    <button class="tab" onclick="showTab('experts')">👥 전문가 현황</button>
                    <button class="tab" onclick="showTab('history')">📈 라벨링 이력</button>
                    <button class="tab" onclick="showTab('quality')">🔍 품질 관리</button>
                </div>

                <!-- 개요 탭 -->
                <div id="overview" class="tab-content active">
                    <div class="chart-container">
                        <h3 class="chart-title">라벨 분포</h3>
                        <canvas id="labelDistributionChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3 class="chart-title">일별 라벨링 현황</h3>
                        <canvas id="dailyLabelingChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- 전문가 현황 탭 -->
                <div id="experts" class="tab-content">
                    <div class="chart-container">
                        <h3 class="chart-title">전문가별 성과</h3>
                        <div id="expertsList">
                            <!-- 전문가 목록이 여기에 로드됩니다 -->
                        </div>
                    </div>
                </div>

                <!-- 라벨링 이력 탭 -->
                <div id="history" class="tab-content">
                    <div class="chart-container">
                        <h3 class="chart-title">라벨링 이력</h3>
                        <div style="margin-bottom: 20px;">
                            <label for="labelFilter">라벨 필터:</label>
                            <select id="labelFilter" onchange="loadLabelingHistory()">
                                <option value="">전체</option>
                                <option value="normal">정상</option>
                                <option value="warning">주의</option>
                                <option value="critical">긴급</option>
                                <option value="unknown">불확실</option>
                            </select>
                            <label for="pageSize" style="margin-left: 20px;">페이지 크기:</label>
                            <select id="pageSize" onchange="loadLabelingHistory()">
                                <option value="10">10개</option>
                                <option value="20" selected>20개</option>
                                <option value="50">50개</option>
                            </select>
                        </div>
                        <table class="data-table" id="historyTable">
                            <thead>
                                <tr>
                                    <th>파일명</th>
                                    <th>라벨</th>
                                    <th>신뢰도</th>
                                    <th>전문가</th>
                                    <th>시간</th>
                                    <th>메모</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- 데이터가 여기에 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 품질 관리 탭 -->
                <div id="quality" class="tab-content">
                    <div class="chart-container">
                        <h3 class="chart-title">라벨 품질 검증</h3>
                        <div style="margin-bottom: 20px;">
                            <button onclick="validateRandomLabels()" style="
                                background: #FF6B6B;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                            ">🎲 랜덤 검증</button>
                            <button onclick="validateAllLabels()" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 15px 30px;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 16px;
                                margin-left: 10px;
                            ">🔍 전체 검증</button>
                        </div>
                        <div id="qualityResults">
                            <!-- 품질 검증 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 알림 영역 -->
            <div id="alertArea"></div>
        </div>
    </div>

    <script>
        let labelingStats = {};
        let labelDistributionChart = null;
        let dailyLabelingChart = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadLabelingStats();
        });

        // 라벨링 통계 로드
        async function loadLabelingStats() {
            try {
                const response = await fetch('/api/ai/labeling-stats');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    labelingStats = data.stats;
                    updateStatsDisplay();
                    createCharts();
                    loadExpertsList();
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                } else {
                    throw new Error(data.message || '통계 로드 실패');
                }
                
            } catch (error) {
                console.error('라벨링 통계 로드 실패:', error);
                showAlert(`데이터 로드 실패: ${error.message}`, 'danger');
            }
        }

        // 통계 표시 업데이트
        function updateStatsDisplay() {
            document.getElementById('totalLabeled').textContent = labelingStats.total_labeled.toLocaleString();
            document.getElementById('todayLabeled').textContent = labelingStats.today_labeled.toLocaleString();
            document.getElementById('accuracy').textContent = labelingStats.accuracy.toFixed(1) + '%';
            document.getElementById('pendingCount').textContent = labelingStats.pending_files.toLocaleString();
        }

        // 차트 생성
        function createCharts() {
            // 라벨 분포 차트
            const labelCtx = document.getElementById('labelDistributionChart').getContext('2d');
            labelDistributionChart = new Chart(labelCtx, {
                type: 'doughnut',
                data: {
                    labels: ['정상', '주의', '긴급', '불확실'],
                    datasets: [{
                        data: [
                            labelingStats.label_distribution.normal,
                            labelingStats.label_distribution.warning,
                            labelingStats.label_distribution.critical,
                            labelingStats.label_distribution.unknown
                        ],
                        backgroundColor: ['#4caf50', '#ff9800', '#f44336', '#9c27b0'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // 일별 라벨링 차트
            const dailyCtx = document.getElementById('dailyLabelingChart').getContext('2d');
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString());
            }
            
            dailyLabelingChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: '라벨링 수',
                        data: [12, 19, 15, 25, 22, 18, 24],
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 전문가 목록 로드
        function loadExpertsList() {
            const expertsList = document.getElementById('expertsList');
            expertsList.innerHTML = '';
            
            // 시뮬레이션된 전문가 데이터
            const experts = [
                {
                    id: 'expert_1',
                    name: '김전문가',
                    total_labeled: 245,
                    accuracy: 96.2,
                    speed: '2.5 files/min',
                    quality: 'excellent'
                },
                {
                    id: 'expert_2',
                    name: '이전문가',
                    total_labeled: 189,
                    accuracy: 94.8,
                    speed: '2.1 files/min',
                    quality: 'good'
                },
                {
                    id: 'expert_3',
                    name: '박전문가',
                    total_labeled: 156,
                    accuracy: 92.1,
                    speed: '1.8 files/min',
                    quality: 'fair'
                }
            ];
            
            experts.forEach(expert => {
                const expertDiv = document.createElement('div');
                expertDiv.className = 'expert-card';
                
                const qualityClass = `quality-${expert.quality}`;
                
                expertDiv.innerHTML = `
                    <div class="expert-name">
                        <span class="quality-indicator ${qualityClass}"></span>
                        ${expert.name}
                    </div>
                    <div class="expert-stats">
                        <div class="expert-stat">
                            <div class="expert-stat-value">${expert.total_labeled}</div>
                            <div class="expert-stat-label">총 라벨링</div>
                        </div>
                        <div class="expert-stat">
                            <div class="expert-stat-value">${expert.accuracy}%</div>
                            <div class="expert-stat-label">정확도</div>
                        </div>
                        <div class="expert-stat">
                            <div class="expert-stat-value">${expert.speed}</div>
                            <div class="expert-stat-label">속도</div>
                        </div>
                        <div class="expert-stat">
                            <div class="expert-stat-value">${expert.quality}</div>
                            <div class="expert-stat-label">품질</div>
                        </div>
                    </div>
                `;
                
                expertsList.appendChild(expertDiv);
            });
        }

        // 탭 전환
        function showTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // 탭별 데이터 로드
            if (tabName === 'history') {
                loadLabelingHistory();
            }
        }

        // 라벨링 이력 로드
        async function loadLabelingHistory() {
            const labelFilter = document.getElementById('labelFilter').value;
            const pageSize = document.getElementById('pageSize').value;
            
            try {
                const url = `/api/ai/labeling-history?limit=${pageSize}${labelFilter ? `&label=${labelFilter}` : ''}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    displayLabelingHistory(data.history);
                } else {
                    throw new Error(data.message || '라벨링 이력 로드 실패');
                }
                
            } catch (error) {
                console.error('라벨링 이력 로드 실패:', error);
                showAlert(`라벨링 이력 로드 실패: ${error.message}`, 'danger');
            }
        }

        // 라벨링 이력 표시
        function displayLabelingHistory(history) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.file_name}</td>
                    <td><span class="badge badge-${item.label}">${item.label}</span></td>
                    <td>${item.confidence}%</td>
                    <td>${item.labeler_id}</td>
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td>${item.notes || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 랜덤 라벨 검증
        async function validateRandomLabels() {
            try {
                const response = await fetch('/api/ai/validate-labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        label_ids: [1, 2, 3, 4, 5] // 랜덤 5개
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    displayQualityResults(data);
                } else {
                    throw new Error(data.message || '라벨 검증 실패');
                }
                
            } catch (error) {
                console.error('라벨 검증 실패:', error);
                showAlert(`라벨 검증 실패: ${error.message}`, 'danger');
            }
        }

        // 전체 라벨 검증
        async function validateAllLabels() {
            showAlert('전체 라벨 검증을 시작합니다...', 'info');
            // 실제로는 더 많은 라벨 ID를 전송
            await validateRandomLabels();
        }

        // 품질 검증 결과 표시
        function displayQualityResults(data) {
            const container = document.getElementById('qualityResults');
            container.innerHTML = `
                <div style="margin: 20px 0;">
                    <h4>검증 결과</h4>
                    <p><strong>전체 정확도:</strong> ${(data.overall_accuracy * 100).toFixed(1)}%</p>
                    <p><strong>검증된 라벨 수:</strong> ${data.results.length}개</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>권장사항</h4>
                    <ul>
                        ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>상세 결과</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>라벨 ID</th>
                                <th>정확성</th>
                                <th>신뢰도</th>
                                <th>제안사항</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.results.map(result => `
                                <tr>
                                    <td>${result.label_id}</td>
                                    <td><span class="badge ${result.is_correct ? 'badge-normal' : 'badge-critical'}">${result.is_correct ? '정확' : '부정확'}</span></td>
                                    <td>${result.confidence_score.toFixed(1)}%</td>
                                    <td>${result.suggestions.join(', ') || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // 알림 표시
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.getElementById('alertArea').appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
